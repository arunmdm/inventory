<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIT- Nuclear Innovations Fission Technology Sample Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        /* MIT Blue for headings and active elements */
        .mit-blue {
            color: #005A9C; /* MIT Blue */
        }
        .mit-blue-bg {
            background-color: #005A9C; /* MIT Blue */
        }
        .mit-light-blue-bg {
            background-color: #ADD8E6; /* Light Blue, can be used for secondary elements */
        }
        .mit-orange {
            color: #E66C00; /* MIT Orange, for accents or warnings */
        }
        .mit-red {
            color: #A31F34; /* MIT Red, for errors or destructive actions */
        }
        .mit-green {
            color: #6C9F3E; /* MIT Green, for success */
        }

        /* General input styling */
        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            outline: none;
        }
        input:focus, select:focus, textarea:focus {
            ring: 2px;
            ring-color: #005A9C;
            border-color: #005A9C;
        }
        /* Button styling */
        button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }
        .tab-button.active {
            background-color: #005A9C;
            color: white;
        }
        .tab-button:not(.active) {
            background-color: #e5e7eb;
            color: #374151;
        }
        .tab-button:not(.active):hover {
            background-color: #d1d5db;
        }

        /* Inline form specific styles for data request */
        .inline-data-request-form-container {
            background-color: #f9fafb;
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }
        .inline-data-request-form-container .form-group {
            margin-bottom: 1rem;
        }

        /* Styles for dynamic sample request blocks */
        .sample-request-block {
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            background-color: white;
            margin-bottom: 1.5rem;
            position: relative;
        }
        .sample-request-block .remove-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #dc2626;
            font-weight: bold;
            font-size: 0.875rem;
            background: none;
            border: none;
            padding: 0.25rem 0.5rem;
        }
        .sample-request-block .remove-button:hover {
            color: #b91c1c;
        }

        /* Composition table styling */
        .composition-table {
            width: 100%;
            border-collapse: collapse;
        }
        .composition-table th, .composition-table td {
            padding: 0.5rem;
            border: 1px solid #e5e7eb;
            font-size: 0.875rem;
        }
        .composition-table th {
            background-color: #f9fafb;
            text-align: left;
            font-weight: 500;
            color: #374151;
        }

        /* Login page specific styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f3f4f6;
        }
        .login-card {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 28rem;
        }
        .error-message {
            color: #dc2626;
            text-align: center;
            margin-bottom: 1rem;
        }
        /* Style for lot number header in tables */
        .lot-header {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: bold;
            font-size: 1.125rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #bfdbfe;
        }
        .tracking-input-row-dynamic, .lot-data-request-row-dynamic {
            background-color: #f9fafb;
        }
        .hidden {
            display: none;
        }
        .form-group {
            margin-bottom: 1rem;
        }
        .grid {
            display: grid;
        }
        .grid-cols-1 {
            grid-template-columns: repeat(1, minmax(0, 1fr));
        }
        .grid-cols-2 {
            grid-template-columns: repeat(2, minmax(0, 1fr));
        }
        .grid-cols-4 {
            grid-template-columns: repeat(4, minmax(0, 1fr));
        }
        .gap-4 {
            gap: 1rem;
        }
        .gap-6 {
            gap: 1.5rem;
        }
        @media (min-width: 768px) {
            .md\\:grid-cols-2 {
                grid-template-columns: repeat(2, minmax(0, 1fr));
            }
            .md\\:grid-cols-4 {
                grid-template-columns: repeat(4, minmax(0, 1fr));
            }
        }
        .items-end {
            align-items: flex-end;
        }
        .mb-3 {
            margin-bottom: 0.75rem;
        }
        .mb-4 {
            margin-bottom: 1rem;
        }
        .mb-6 {
            margin-bottom: 1.5rem;
        }
        .mb-8 {
            margin-bottom: 2rem;
        }
        .mt-4 {
            margin-top: 1rem;
        }
        .mt-6 {
            margin-top: 1.5rem;
        }
        .mt-8 {
            margin-top: 2rem;
        }
        .p-4 {
            padding: 1rem;
        }
        .p-6 {
            padding: 1.5rem;
        }
        .px-4 {
            padding-left: 1rem;
            padding-right: 1rem;
        }
        .py-2 {
            padding-top: 0.5rem;
            padding-bottom: 0.5rem;
        }
        .py-3 {
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
        .text-sm {
            font-size: 0.875rem;
        }
        .text-lg {
            font-size: 1.125rem;
        }
        .text-xl {
            font-size: 1.25rem;
        }
        .text-2xl {
            font-size: 1.5rem;
        }
        .text-3xl {
            font-size: 1.875rem;
        }
        .font-medium {
            font-weight: 500;
        }
        .font-semibold {
            font-weight: 600;
        }
        .font-bold {
            font-weight: 700;
        }
        .text-center {
            text-align: center;
        }
        .text-gray-600 {
            color: #4b5563;
        }
        .text-gray-700 {
            color: #374151;
        }
        .text-gray-800 {
            color: #1f2937;
        }
        .text-white {
            color: white;
        }
        .bg-white {
            background-color: white;
        }
        .bg-gray-50 {
            background-color: #f9fafb;
        }
        .bg-gray-100 {
            background-color: #f3f4f6;
        }
        .bg-gray-200 {
            background-color: #e5e7eb;
        }
        .bg-blue-50 {
            background-color: #eff6ff;
        }
        .bg-yellow-50 {
            background-color: #fefce8;
        }
        .bg-green-600 {
            background-color: #16a34a;
        }
        .bg-green-600:hover {
            background-color: #15803d;
        }
        .bg-red-500 {
            background-color: #ef4444;
        }
        .bg-red-500:hover {
            background-color: #dc2626;
        }
        .bg-gray-300 {
            background-color: #d1d5db;
        }
        .bg-gray-300:hover {
            background-color: #9ca3af;
        }
        .border {
            border-width: 1px;
        }
        .border-blue-200 {
            border-color: #bfdbfe;
        }
        .border-yellow-200 {
            border-color: #fde047;
        }
        .border-gray-200 {
            border-color: #e5e7eb;
        }
        .border-gray-300 {
            border-color: #d1d5db;
        }
        .rounded-md {
            border-radius: 0.375rem;
        }
        .rounded-lg {
            border-radius: 0.5rem;
        }
        .shadow-sm {
            box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
        }
        .shadow-md {
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }
        .shadow-lg {
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
        }
        .container {
            container-type: inline-size;
        }
        .mx-auto {
            margin-left: auto;
            margin-right: auto;
        }
        .max-w-4xl {
            max-width: 56rem;
        }
        .my-8 {
            margin-top: 2rem;
            margin-bottom: 2rem;
        }
        .flex {
            display: flex;
        }
        .flex-wrap {
            flex-wrap: wrap;
        }
        .justify-center {
            justify-content: center;
        }
        .justify-end {
            justify-content: flex-end;
        }
        .justify-between {
            justify-content: space-between;
        }
        .items-center {
            align-items: center;
        }
        .space-x-4 > * + * {
            margin-left: 1rem;
        }
        .w-full {
            width: 100%;
        }
        .w-4 {
            width: 1rem;
        }
        .h-4 {
            height: 1rem;
        }
        .mr-2 {
            margin-right: 0.5rem;
        }
        .ml-2 {
            margin-left: 0.5rem;
        }
        .border-b-2 {
            border-bottom-width: 2px;
        }
        .border-t {
            border-top-width: 1px;
        }
        .border-b {
            border-bottom-width: 1px;
        }
        .rounded-t-lg {
            border-top-left-radius: 0.5rem;
            border-top-right-radius: 0.5rem;
        }
        .transition-colors {
            transition-property: color, background-color, border-color;
            transition-duration: 0.3s;
        }
        .duration-300 {
            transition-duration: 0.3s;
        }
        .ease-in-out {
            transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1);
        }
        .col-span-full {
            grid-column: 1 / -1;
        }
        .min-w-full {
            min-width: 100%;
        }
        .overflow-x-auto {
            overflow-x: auto;
        }
        .uppercase {
            text-transform: uppercase;
        }
        .tracking-wider {
            letter-spacing: 0.05em;
        }
        .rounded-tl-md {
            border-top-left-radius: 0.375rem;
        }
        .rounded-tr-md {
            border-top-right-radius: 0.375rem;
        }
        .inline-flex {
            display: inline-flex;
        }
        .form-checkbox, .form-radio {
            width: 1.25rem;
            height: 1.25rem;
        }
        .relative {
            position: relative;
        }
        .absolute {
            position: absolute;
        }
        .top-4 {
            top: 1rem;
        }
        .right-4 {
            right: 1rem;
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <h2 class="text-2xl font-bold text-center mb-6 mit-blue">Login to MIT Nuclear Innovations Fission Technology Sample Management</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username:</label>
                    <input type="text" id="username" name="username" placeholder="admin" required>
                </div>
                <div class="form-group mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password:</label>
                    <input type="password" id="password" name="password" placeholder="password123" required>
                </div>
                <p id="loginError" class="error-message hidden">Invalid username or password.</p>
                <button type="submit" class="mit-blue-bg text-white w-full py-3 rounded-md transition duration-300" id="loginButton">Login</button>
            </form>
        </div>
    </div>

    <div id="mainContent" class="container mx-auto p-6 bg-white shadow-lg rounded-lg my-8 max-w-4xl hidden">
        <h1 class="text-3xl font-bold text-center mb-6 mit-blue">MIT- Nuclear Innovations Fission Technology Sample Management System</h1>

        <div class="flex flex-wrap justify-center mb-8 border-b-2 border-gray-200">
            <button class="tab-button py-3 px-6 rounded-t-lg text-lg font-medium transition-colors duration-300 active" onclick="openTab(event, 'requestSample')">Request Sample</button>
            <button class="tab-button py-3 px-6 rounded-t-lg text-lg font-medium transition-colors duration-300" onclick="openTab(event, 'trackSamples')">Track Samples</button>
            <button class="tab-button py-3 px-6 rounded-t-lg text-lg font-medium transition-colors duration-300" onclick="openTab(event, 'viewData')">View Sample Data</button>
        </div>

        <div id="requestSample" class="tab-content active">
            <h2 class="text-2xl font-semibold mb-6 mit-blue">Submit a New Sample Request</h2>
            <p class="text-gray-600 mb-6">Fill out the form below to submit new sample requests. Remember to specify details for each sample and provide a unique Lot Number for the batch. Click "Add Another Sample" to include multiple samples under the same lot.</p>
            <form id="sampleRequestForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="text-xl font-semibold col-span-full mit-blue mb-4">Collaborator Information</h3>
                    <div class="form-group">
                        <label for="collaboratorName" class="block text-sm font-medium text-gray-700 mb-2">Name:</label>
                        <input type="text" id="collaboratorName" name="collaboratorName" placeholder="John Doe" required>
                    </div>
                    <div class="form-group">
                        <label for="collaboratorCompany" class="block text-sm font-medium text-gray-700 mb-2">Company:</label>
                        <input type="text" id="collaboratorCompany" name="collaboratorCompany" placeholder="e.g., MIT, Acme Materials Inc." required>
                    </div>
                    <div class="form-group">
                        <label for="collaboratorEmail" class="block text-sm font-medium text-gray-700 mb-2">Email:</label>
                        <input type="email" id="collaboratorEmail" name="collaboratorEmail" placeholder="johndoe@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="collaboratorPhone" class="block text-sm font-medium text-gray-700 mb-2">Phone (Optional):</label>
                        <input type="text" id="collaboratorPhone" name="collaboratorPhone" placeholder="e.g., +1-123-456-7890">
                    </div>
                </div>

                <div class="form-group mb-6 p-6 bg-yellow-50 rounded-lg border border-yellow-200">
                    <label for="lotNumber" class="block text-sm font-medium text-gray-700 mb-2">Lot Number (for this batch of samples):</label>
                    <input type="text" id="lotNumber" name="lotNumber" placeholder="e.g., LOT-2025-001" required>
                </div>

                <div id="sampleRequestsContainer"></div>

                <div class="flex justify-center mt-6 mb-8">
                    <button type="button" onclick="addSampleRequest()" class="bg-green-600 text-white py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Add Another Sample
                    </button>
                </div>

                <div class="form-group">
                    <label for="generalSpecialInstructions" class="block text-sm font-medium text-gray-700 mb-2">General Special Instructions for All Samples:</label>
                    <textarea id="generalSpecialInstructions" name="generalSpecialInstructions" rows="4" placeholder="Any overall requirements or details not covered above for all samples..."></textarea>
                </div>

                <div class="form-group text-center mt-8">
                    <button type="submit" class="mit-blue-bg text-white py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out">Submit All Requests</button>
                </div>
            </form>
        </div>

        <div id="trackSamples" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 mit-blue">Track Your Sample Requests</h2>
            <p class="text-gray-600 mb-6">Monitor the status of your submitted samples here, grouped by Lot Number. Once approved, you'll find shipping instructions. Use the 'Add Tracking Details' button for each lot to enter tracking numbers when available. You will receive an approval email with further instructions.</p>
            <div class="flex justify-end mb-4">
                <button type="button" onclick="refreshTrackSamples()" class="mit-blue-bg text-white py-2 px-4 rounded-md flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004 10.59V10m5-3.54l-3 3m0 0l3 3m-3-3H2m14 2.5v4h.582m-15.356-2A8.001 8.001 0 0120 13.41V14m-5 3.54l3-3m0 0l-3-3m3 3H22"></path>
                    </svg>
                    Refresh
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-md">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-md">Sample ID</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Material</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Experiment Type</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Approval Date</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Shipping Instructions</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-md">Tracking Number</th>
                        </tr>
                    </thead>
                    <tbody id="sampleTrackingTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="viewData" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 mit-blue">View Sample Data</h2>
            <p class="text-gray-600 mb-6">Access data for your completed samples here, grouped by Lot Number. You can request data for individual samples or for an entire lot. Note that requesting data for an entire lot might take longer; consider requesting specific samples for a faster response. You will receive an email if new updates are made to the sample.</p>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-md">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-md">Sample ID</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Experiment Type</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Last Updated Date</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Request Data</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-md">Data Available</th>
                        </tr>
                    </thead>
                    <tbody id="sampleDataTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let sampleCounter = 0;
        let allSamplesData = [];
        
        // REPLACE THIS WITH YOUR DEPLOYED GOOGLE APPS SCRIPT URL
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxHDS5e4O99vvWV1eJ8mU4Cy3t0Kr9fs050k_uMkGIgnzMvXoqgfoIsZNOf5gr6ZMAkJA/exec';

        // Periodic elements data (keeping the original data structure)
        const periodicElements = [
            { symbol: "H", name: "Hydrogen", isotopes: ["1H", "2H", "3H"] },
            { symbol: "He", name: "Helium", isotopes: ["3He", "4He"] },
            { symbol: "Li", name: "Lithium", isotopes: ["6Li", "7Li"] },
            // ... (keeping the rest of the periodic elements data as is)
        ];

        const isotopeMap = {};
        periodicElements.forEach(el => {
            isotopeMap[el.symbol] = el.isotopes;
        });

        // Enhanced login function with better error handling
        async function handleLogin(event) {
            event.preventDefault();
            
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');

            // Show loading state
            loginButton.disabled = true;
            loginButton.textContent = 'Logging in...';
            loginError.classList.add('hidden');

            const payload = {
                type: 'login',
                username: usernameInput.value.trim(),
                password: passwordInput.value.trim()
            };

            console.log('Attempting login with:', { username: payload.username, password: '[HIDDEN]' });
            console.log('Sending to URL:', WEB_APP_URL);

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                console.log('Response status:', response.status);
                console.log('Response headers:', response.headers);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Login response:', result);

                if (result.success) {
                    console.log('Login successful, switching to main content');
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    
                    // Initialize the application
                    addSampleRequest();
                    renderTrackSamplesTable();
                    renderViewDataTable();
                } else {
                    console.log('Login failed:', result.message);
                    loginError.classList.remove('hidden');
                    loginError.textContent = result.message || 'Login failed. Please try again.';
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.classList.remove('hidden');
                loginError.textContent = `Connection error: ${error.message}. Please check your network connection and try again.`;
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Login';
            }
        }

        // Enhanced data sending function with better error handling
        async function sendDataToGoogleAppsScript(payload) {
            try {
                console.log('Sending data:', payload);
                
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    let errorMessage = `HTTP error! Status: ${response.status}`;
                    try {
                        const errorText = await response.text();
                        errorMessage += ` - Details: ${errorText}`;
                    } catch (e) {
                        // If response.text() fails, just use the status
                    }
                    console.error("Server responded with an error:", errorMessage);
                    return { success: false, message: `Server error: ${errorMessage}` };
                }

                const result = await response.json();
                console.log("Server response:", result);

                return result;
            } catch (error) {
                console.error("Network or fetch error:", error);
                return { 
                    success: false, 
                    message: `Network error: Could not connect to the server. Please check your internet connection. (Details: ${error.message})` 
                };
            }
        }

        // Sample management functions (simplified for this fix)
        function generateSampleBlockHtml(index) {
            return `
                <div class="sample-request-block" data-sample-index="${index}">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Sample #<span class="sample-index-display">${index + 1}</span></h3>
                    ${index > 0 ? `<button type="button" class="remove-button" onclick="removeSampleRequest(this)">Remove</button>` : ''}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="sampleID-${index}" class="block text-sm font-medium text-gray-700 mb-2">Proposed Sample ID:</label>
                            <input type="text" id="sampleID-${index}" name="sampleID-${index}" placeholder="MIT-SAMPLE-XYZ" required>
                        </div>
                        <div class="form-group">
                            <label for="materialType-${index}" class="block text-sm font-medium text-gray-700 mb-2">Material Type:</label>
                            <input type="text" id="materialType-${index}" name="materialType-${index}" placeholder="Stainless Steel 316L" required>
                        </div>
                        <div class="form-group">
                            <label for="sampleShape-${index}" class="block text-sm font-medium text-gray-700 mb-2">Sample Shape:</label>
                            <select id="sampleShape-${index}" name="sampleShape-${index}" required>
                                <option value="">Select a shape</option>
                                <option value="Cylinder">Cylinder</option>
                                <option value="Dogbone">Dogbone</option>
                                <option value="Disc">Disc</option>
                                <option value="Cube">Cube</option>
                                <option value="Plate">Plate</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="weight-${index}" class="block text-sm font-medium text-gray-700 mb-2">Weight (grams):</label>
                            <input type="number" id="weight-${index}" name="weight-${index}" placeholder="e.g., 5.2" step="any" required>
                        </div>
                    </div>
                    
                    <div class="form-group mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Intended Experiment Type:</label>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-2">
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="experimentType-${index}" value="Irradiation" class="form-checkbox">
                                <span class="ml-2 text-gray-700">Irradiation</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="experimentType-${index}" value="High Temperature Testing" class="form-checkbox">
                                <span class="ml-2 text-gray-700">High Temperature Testing</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="experimentType-${index}" value="Corrosion Testing" class="form-checkbox">
                                <span class="ml-2 text-gray-700">Corrosion Testing</span>
                            </label>
                            <label class="inline-flex items-center">
                                <input type="checkbox" name="experimentType-${index}" value="Characterization" class="form-checkbox">
                                <span class="ml-2 text-gray-700">Characterization</span>
                            </label>
                        </div>
                    </div>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div class="form-group">
                            <label for="quantity-${index}" class="block text-sm font-medium text-gray-700 mb-2">Required Quantity:</label>
                            <input type="number" id="quantity-${index}" name="quantity-${index}" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="desiredCompletionDate-${index}" class="block text-sm font-medium text-gray-700 mb-2">Desired Completion Date:</label>
                            <input type="date" id="desiredCompletionDate-${index}" name="desiredCompletionDate-${index}">
                        </div>
                    </div>
                    
                    <div class="form-group mt-4">
                        <label for="sampleSpecialInstructions-${index}" class="block text-sm font-medium text-gray-700 mb-2">Sample Specific Instructions/Notes:</label>
                        <textarea id="sampleSpecialInstructions-${index}" name="sampleSpecialInstructions-${index}" rows="3" placeholder="Any specific requirements or details for this sample..."></textarea>
                    </div>
                </div>
            `;
        }

        function addSampleRequest() {
            const container = document.getElementById('sampleRequestsContainer');
            const newBlockHtml = generateSampleBlockHtml(sampleCounter);
            container.insertAdjacentHTML('beforeend', newBlockHtml);
            sampleCounter++;
        }

        function removeSampleRequest(buttonElement) {
            const blockToRemove = buttonElement.closest('.sample-request-block');
            if (blockToRemove) {
                blockToRemove.remove();
                const remainingBlocks = document.querySelectorAll('#sampleRequestsContainer .sample-request-block');
                remainingBlocks.forEach((block, index) => {
                    block.dataset.sampleIndex = index;
                    block.querySelector('.sample-index-display').textContent = index + 1;
                });
                sampleCounter = remainingBlocks.length;
            }
        }

        // Form submission handler
        document.getElementById('sampleRequestForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const formData = new FormData(this);
            const lotNumber = formData.get('lotNumber');

            const requestData = {
                type: 'sampleRequest',
                collaboratorName: formData.get('collaboratorName'),
                collaboratorCompany: formData.get('collaboratorCompany'),
                collaboratorEmail: formData.get('collaboratorEmail'),
                collaboratorPhone: formData.get('collaboratorPhone'),
                generalSpecialInstructions: formData.get('generalSpecialInstructions'),
                lotNumber: lotNumber,
                samples: []
            };

            // Collect sample data
            document.querySelectorAll('#sampleRequestsContainer .sample-request-block').forEach((block, sampleIndex) => {
                const sample = {
                    sampleID: block.querySelector(`#sampleID-${sampleIndex}`).value,
                    materialType: block.querySelector(`#materialType-${sampleIndex}`).value,
                    sampleShape: block.querySelector(`#sampleShape-${sampleIndex}`).value,
                    weight: block.querySelector(`#weight-${sampleIndex}`).value,
                    quantity: block.querySelector(`#quantity-${sampleIndex}`).value,
                    desiredCompletionDate: block.querySelector(`#desiredCompletionDate-${sampleIndex}`).value,
                    sampleSpecialInstructions: block.querySelector(`#sampleSpecialInstructions-${sampleIndex}`).value,
                    experimentTypes: [],
                    composition: [],
                    dimensions: {}
                };

                // Collect experiment types
                block.querySelectorAll(`input[name^="experimentType-${sampleIndex}"]:checked`).forEach(checkbox => {
                    sample.experimentTypes.push({ type: checkbox.value, details: '' });
                });

                requestData.samples.push(sample);
            });

            const result = await sendDataToGoogleAppsScript(requestData);

            if (result.success) {
                alert('Sample request submitted successfully!');
                this.reset();
                document.getElementById('sampleRequestsContainer').innerHTML = '';
                sampleCounter = 0;
                addSampleRequest();
            } else {
                alert('Error submitting request: ' + result.message);
            }
        });

        // Dummy data for demonstration
        const dummySamples = [
            { 
                lotNumber: "LOT-2025-001", 
                collaboratorEmail: "user1@example.com", 
                samples: [
                    { 
                        sampleID: "MIT-SAMPLE-001", 
                        materialType: "Alloy 625", 
                        experimentType: "High Temperature", 
                        status: "Pending", 
                        approvalDate: "N/A", 
                        shippingInstructions: "Awaiting approval...", 
                        trackingNumber: "", 
                        dataUploadDate: "N/A", 
                        dataAvailable: "No data uploaded yet." 
                    }
                ]
            }
        ];

        allSamplesData = dummySamples;

        function renderTrackSamplesTable() {
            const tbody = document.getElementById('sampleTrackingTableBody');
            tbody.innerHTML = '';

            allSamplesData.forEach(lot => {
                const lotHeaderRow = document.createElement('tr');
                lotHeaderRow.innerHTML = `<td colspan="7" class="lot-header">Lot Number: ${lot.lotNumber}</td>`;
                tbody.appendChild(lotHeaderRow);

                lot.samples.forEach(sample => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200';
                    row.innerHTML = `
                        <td class="py-3 px-4">${sample.sampleID}</td>
                        <td class="py-3 px-4">${sample.materialType}</td>
                        <td class="py-3 px-4">${sample.experimentType || 'N/A'}</td>
                        <td class="py-3 px-4">${sample.status}</td>
                        <td class="py-3 px-4">${sample.approvalDate || 'N/A'}</td>
                        <td class="py-3 px-4">${sample.shippingInstructions}</td>
                        <td class="py-3 px-4">${sample.trackingNumber || 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        function renderViewDataTable() {
            const tbody = document.getElementById('sampleDataTableBody');
            tbody.innerHTML = '';

            allSamplesData.forEach(lot => {
                const lotHeaderRow = document.createElement('tr');
                lotHeaderRow.innerHTML = `<td colspan="5" class="lot-header">Lot Number: ${lot.lotNumber}</td>`;
                tbody.appendChild(lotHeaderRow);

                lot.samples.forEach(sample => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200';
                    row.innerHTML = `
                        <td class="py-3 px-4">${sample.sampleID}</td>
                        <td class="py-3 px-4">${sample.experimentType || 'N/A'}</td>
                        <td class="py-3 px-4">${sample.dataUploadDate || 'N/A'}</td>
                        <td class="py-3 px-4">
                            <button class="mit-blue-bg text-white px-4 py-2 rounded-md text-sm">Request Data</button>
                        </td>
                        <td class="py-3 px-4">${sample.dataAvailable || 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        function refreshTrackSamples() {
            console.log("Refreshing sample tracking data...");
            alert("Sample tracking data refreshed!");
            renderTrackSamplesTable();
        }

        // Tab functionality
        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.add("hidden");
                tabcontent[i].classList.remove("active");
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.remove("hidden");
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // Initialize the application
        console.log('Application initialized, waiting for login...');
