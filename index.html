<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIT- Nuclear Innovations Fission Technology Sample Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body */
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800;
        }
        /* MIT Blue for headings and active elements */
        .mit-blue {
            color: #005A9C; /* MIT Blue */
        }
        .mit-blue-bg {
            background-color: #005A9C; /* MIT Blue */
        }
        .mit-light-blue-bg {
            background-color: #ADD8E6; /* Light Blue, can be used for secondary elements */
        }
        .mit-orange {
            color: #E66C00; /* MIT Orange, for accents or warnings */
        }
        .mit-red {
            color: #A31F34; /* MIT Red, for errors or destructive actions */
        }
        .mit-green {
            color: #6C9F3E; /* MIT Green, for success */
        }

        /* General input styling */
        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            @apply w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-mit-blue;
        }
        /* Button styling */
        button {
            @apply px-6 py-3 rounded-md font-semibold transition duration-300 ease-in-out;
        }
        .tab-button.active {
            @apply mit-blue-bg text-white;
        }
        .tab-button:not(.active) {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }

        /* Inline form specific styles for data request */
        .inline-data-request-form-container {
            @apply bg-gray-50 p-6 border-t border-b border-gray-200;
        }
        .inline-data-request-form-container .form-group {
            margin-bottom: 1rem; /* Adjust spacing for inline form */
        }

        /* Styles for dynamic sample request blocks */
        .sample-request-block {
            @apply border border-gray-200 p-6 rounded-lg shadow-sm bg-white mb-6 relative;
        }
        .sample-request-block .remove-button {
            @apply absolute top-4 right-4 text-red-500 hover:text-red-700 font-bold text-sm;
        }

        /* Composition table styling */
        .composition-table {
            @apply w-full border-collapse;
        }
        .composition-table th, .composition-table td {
            @apply p-2 border border-gray-200 text-sm;
        }
        .composition-table th {
            @apply bg-gray-50 text-left font-medium text-gray-700;
        }

        /* Login page specific styles */
        .login-container {
            @apply flex items-center justify-center min-h-screen bg-gray-100;
        }
        .login-card {
            @apply bg-white p-8 rounded-lg shadow-lg w-full max-w-md;
        }
        .error-message {
            @apply text-red-600 text-center mb-4;
        }
        /* Style for lot number header in tables */
        /* Removed lot-header styling as lot grouping is removed from table rendering */

        /* Modal styles */
        .modal {
            display: none; /* Hidden by default */
            position: fixed; /* Stay in place */
            z-index: 1000; /* Sit on top */
            left: 0;
            top: 0;
            width: 100%; /* Full width */
            height: 100%; /* Full height */
            overflow: auto; /* Enable scroll if needed */
            background-color: rgba(0,0,0,0.4); /* Black w/ opacity */
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: #fefefe;
            margin: auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 8px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
            text-align: center;
        }
        .close-button {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
        }
        .close-button:hover,
        .close-button:focus {
            color: black;
            text-decoration: none;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <h2 class="text-2xl font-bold text-center mb-6 mit-blue">Login to MIT Nuclear Innovations Fission Technology Sample Management</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username:</label>
                    <input type="text" id="username" name="username" placeholder="admin" required>
                </div>
                <div class="form-group mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password:</label>
                    <input type="password" id="password" name="password" placeholder="password123" required>
                </div>
                <p id="loginError" class="error-message hidden">Invalid username or password.</p>
                <button type="submit" class="mit-blue-bg text-white w-full py-3 rounded-md hover:opacity-90 transition duration-300">Login</button>
            </form>
        </div>
    </div>

    <div id="mainContent" class="container mx-auto p-6 md:p-10 bg-white shadow-lg rounded-lg my-8 max-w-4xl hidden">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 mit-blue">MIT- Nuclear Innovations Fission Technology Sample Management System</h1>

        <div class="flex flex-wrap justify-center mb-8 border-b-2 border-gray-200">
            <button class="tab-button py-3 px-6 rounded-t-lg text-lg font-medium transition-colors duration-300 active" onclick="openTab(event, 'requestSample')">Request Sample</button>
            <button class="tab-button py-3 px-6 rounded-t-lg text-lg font-medium transition-colors duration-300" onclick="openTab(event, 'trackSamples')">Track Samples</button>
            <button class="tab-button py-3 px-6 rounded-t-lg text-lg font-medium transition-colors duration-300" onclick="openTab(event, 'viewData')">View Sample Data</button>
        </div>

        <div id="requestSample" class="tab-content active">
            <h2 class="text-2xl font-semibold mb-6 mit-blue">Submit a New Sample Request</h2>
            <p class="text-gray-600 mb-6">Fill out the form below to submit new sample requests. Remember to specify details for each sample and provide a unique Lot Number for the batch. Click "Add Another Sample" to include multiple samples under the same lot.</p>
            <form id="sampleRequestForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="text-xl font-semibold col-span-full mit-blue mb-4">Collaborator Information</h3>
                    <div class="form-group">
                        <label for="collaboratorName" class="block text-sm font-medium text-gray-700 mb-2">Name:</label>
                        <input type="text" id="collaboratorName" name="collaboratorName" placeholder="John Doe" required>
                    </div>
                    <div class="form-group">
                        <label for="collaboratorCompany" class="block text-sm font-medium text-gray-700 mb-2">Company:</label>
                        <input type="text" id="collaboratorCompany" name="collaboratorCompany" placeholder="e.g., MIT, Acme Materials Inc." required>
                    </div>
                    <div class="form-group">
                        <label for="collaboratorEmail" class="block text-sm font-medium text-gray-700 mb-2">Email:</label>
                        <input type="email" id="collaboratorEmail" name="collaboratorEmail" placeholder="johndoe@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="collaboratorPhone" class="block text-sm font-medium text-gray-700 mb-2">Phone (Optional):</label>
                        <input type="text" id="collaboratorPhone" name="collaboratorPhone" placeholder="e.g., +1-123-456-7890">
                    </div>
                </div>

                <div class="form-group mb-6 p-6 bg-yellow-50 rounded-lg border border-yellow-200">
                    <label for="lotNumber" class="block text-sm font-medium text-gray-700 mb-2">Lot Number (for this batch of samples):</label>
                    <input type="text" id="lotNumber" name="lotNumber" placeholder="e.g., LOT-2025-001" required>
                </div>

                <div id="sampleRequestsContainer">
                    </div>

                <div class="flex justify-center mt-6 mb-8">
                    <button type="button" onclick="addSampleRequest()" class="bg-green-600 hover:bg-green-700 text-white py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Add Another Sample
                    </button>
                </div>

                <div class="form-group col-span-1 md:col-span-2">
                    <label for="generalSpecialInstructions" class="block text-sm font-medium text-gray-700 mb-2">General Special Instructions for All Samples:</label>
                    <textarea id="generalSpecialInstructions" name="generalSpecialInstructions" rows="4" placeholder="Any overall requirements or details not covered above for all samples..."></textarea>
                </div>

                <div class="form-group col-span-1 md:col-span-2 text-center mt-8">
                    <button type="submit" class="mit-blue-bg hover:opacity-90 text-white py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out">Submit All Requests</button>
                </div>
            </form>
        </div>

        <div id="trackSamples" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 mit-blue">Track Your Sample Requests</h2>
            <p class="text-gray-600 mb-6">Monitor the status of your submitted samples here. Once approved, you'll find shipping instructions. Use the 'Add Tracking Details' button to enter tracking numbers when available. You will receive an approval email with further instructions.</p>
            <div class="flex justify-end mb-4">
                <button type="button" onclick="refreshTrackSamples()" class="mit-blue-bg hover:opacity-90 text-white py-2 px-5 rounded-md flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004 10.59V10m5-3.54l-3 3m0 0l3 3m-3-3H2m14 2.5v4h.582m-15.356-2A8.001 8.001 0 0120 13.41V14m-5 3.54l3-3m0 0l-3-3m3 3H22"></path></svg>
                    Refresh
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-md">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-md">Lot Number</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Sample ID</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Material</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Experiment Type</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Approval Date</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Shipping Instructions</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-md">Tracking Number</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Action</th>
                        </tr>
                    </thead>
                    <tbody id="sampleTrackingTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="viewData" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 mit-blue">View Sample Data</h2>
            <p class="text-gray-600 mb-6">Access data for your completed samples here. You can request data for individual samples. You will receive an email if new updates are made to the sample.</p>
            <div class="flex justify-end mb-4">
                <button type="button" onclick="refreshViewData()" class="mit-blue-bg hover:opacity-90 text-white py-2 px-5 rounded-md flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004 10.59V10m5-3.54l-3 3m0 0l3 3m-3-3H2m14 2.5v4h.582m-15.356-2A8.001 8.001 0 0120 13.41V14m-5 3.54l3-3m0 0l-3-3m3 3H22"></path></svg>
                    Refresh
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-md">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-md">Lot Number</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Sample ID</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Experiment Type</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Last Updated Date</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Data Available</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-md">Action</th>
                        </tr>
                    </thead>
                    <tbody id="sampleDataTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <div id="messageModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('messageModal')">&times;</span>
            <p id="modalMessage" class="text-lg font-semibold text-gray-800"></p>
            <button onclick="closeModal('messageModal')" class="mt-4 mit-blue-bg text-white py-2 px-5 rounded-md hover:opacity-90 transition duration-300">OK</button>
        </div>
    </div>

    <div id="addTrackingModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('addTrackingModal')">&times;</span>
            <h3 class="text-xl font-semibold mb-4 mit-blue">Add Tracking Details</h3>
            <div class="form-group mb-4">
                <label for="modalTrackingLotNumber" class="block text-sm font-medium text-gray-700 mb-2">Lot Number:</label>
                <input type="text" id="modalTrackingLotNumber" class="w-full p-2 border rounded" readonly>
            </div>
            <div class="form-group mb-4">
                <label for="modalTrackingSampleId" class="block text-sm font-medium text-gray-700 mb-2">Sample ID:</label>
                <input type="text" id="modalTrackingSampleId" class="w-full p-2 border rounded" readonly>
            </div>
            <div class="form-group mb-4">
                <label for="modalTrackingNumber" class="block text-sm font-medium text-gray-700 mb-2">Tracking Number:</label>
                <input type="text" id="modalTrackingNumber" placeholder="Enter Tracking Number" class="w-full p-2 border rounded">
            </div>
            <div class="form-group mb-4">
                <label for="modalTrackingDate" class="block text-sm font-medium text-gray-700 mb-2">Tracking Date:</label>
                <input type="date" id="modalTrackingDate" class="w-full p-2 border rounded">
            </div>
            <div class="form-group mb-6">
                <label for="modalTrackingNotes" class="block text-sm font-medium text-gray-700 mb-2">Notes (Optional):</label>
                <textarea id="modalTrackingNotes" rows="3" placeholder="Any additional notes..." class="w-full p-2 border rounded"></textarea>
            </div>
            <button onclick="submitTrackingDetails()" class="mit-blue-bg text-white py-2 px-5 rounded-md hover:opacity-90 transition duration-300">Submit Tracking</button>
            <button onclick="closeModal('addTrackingModal')" class="ml-2 bg-gray-300 text-gray-800 py-2 px-5 rounded-md hover:bg-gray-400 transition duration-300">Cancel</button>
        </div>
    </div>

    <div id="requestDataModal" class="modal">
        <div class="modal-content">
            <span class="close-button" onclick="closeModal('requestDataModal')">&times;</span>
            <h3 class="text-xl font-semibold mb-4 mit-blue">Request Sample Data</h3>
            <p class="mb-4">You are requesting data for:</p>
            <p class="font-semibold mb-2">Lot Number: <span id="modalRequestDataLotNumber"></span></p>
            <p class="font-semibold mb-4">Sample ID: <span id="modalRequestDataSampleId"></span></p>
            <div class="form-group mb-6">
                <label for="modalRequestDataType" class="block text-sm font-medium text-gray-700 mb-2">Type of Data Request:</label>
                <select id="modalRequestDataType" class="w-full p-2 border rounded">
                    <option value="Individual Sample Data">Individual Sample Data</option>
                    <option value="Full Report">Full Report</option>
                    <option value="Raw Data Files">Raw Data Files</option>
                </select>
            </div>
            <button onclick="submitRequestData()" class="mit-blue-bg text-white py-2 px-5 rounded-md hover:opacity-90 transition duration-300">Confirm Request</button>
            <button onclick="closeModal('requestDataModal')" class="ml-2 bg-gray-300 text-gray-800 py-2 px-5 rounded-md hover:bg-gray-400 transition duration-300">Cancel</button>
        </div>
    </div>


    <script>
        let sampleCounter = 0; // Global counter for unique sample block IDs
        const ADMIN_EMAIL = 'arunmdm@mit.edu'; // Admin email for notifications
        // IMPORTANT: Replace this with your deployed Google Apps Script Web App URL
        const GOOGLE_SHEET_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbw6JPbYWzTcvmldl7b6U9dTboZbxMaMt1cjc15eGzuxZ694uIDtMUKAFtH712h0tmd_/exec'; // *** REPLACE THIS ***

        // Data for periodic table elements and their isotopes
        const periodicElements = [
            { symbol: "H", name: "Hydrogen", isotopes: ["1H", "2H", "3H"] },
            { symbol: "He", name: "Helium", isotopes: ["3He", "4He"] },
            { symbol: "Li", name: "Lithium", isotopes: ["6Li", "7Li"] },
            { symbol: "Be", name: "Beryllium", isotopes: ["9Be"] },
            { symbol: "B", name: "Boron", isotopes: ["10B", "11B"] },
            { symbol: "C", name: "Carbon", isotopes: ["12C", "13C", "14C"] },
            { symbol: "N", name: "Nitrogen", isotopes: ["14N", "15N"] },
            { symbol: "O", name: "Oxygen", isotopes: ["16O", "17O", "18O"] },
            { symbol: "F", name: "Fluorine", isotopes: ["19F"] },
            { symbol: "Ne", name: "Neon", isotopes: ["20Ne", "21Ne", "22Ne"] },
            { symbol: "Na", name: "Sodium", isotopes: ["23Na"] },
            { symbol: "Mg", name: "Magnesium", isotopes: ["24Mg", "25Mg", "26Mg"] },
            { symbol: "Al", name: "Aluminum", isotopes: ["27Al"] },
            { symbol: "Si", name: "Silicon", isotopes: ["28Si", "29Si", "30Si"] },
            { symbol: "P", name: "Phosphorus", isotopes: ["31P"] },
            { symbol: "S", name: "Sulfur", isotopes: ["32S", "33S", "34S", "36S"] },
            { symbol: "Cl", name: "Chlorine", isotopes: ["35Cl", "37Cl"] },
            { symbol: "Ar", name: "Argon", isotopes: ["36Ar", "38Ar", "40Ar"] },
            { symbol: "K", name: "Potassium", isotopes: ["39K", "40K", "41K"] },
            { symbol: "Ca", name: "Calcium", isotopes: ["40Ca", "42Ca", "43Ca", "44Ca", "46Ca", "48Ca"] },
            { symbol: "Sc", name: "Scandium", isotopes: ["45Sc"] },
            { symbol: "Ti", name: "Titanium", isotopes: ["46Ti", "47Ti", "48Ti", "49Ti", "50Ti"] },
            { symbol: "V", name: "Vanadium", isotopes: ["50V", "51V"] },
            { symbol: "Cr", name: "Chromium", isotopes: ["50Cr", "52Cr", "53Cr", "54Cr"] },
            { symbol: "Mn", name: "Manganese", isotopes: ["55Mn"] },
            { symbol: "Fe", name: "Iron", isotopes: ["54Fe", "56Fe", "57Fe", "58Fe"] },
            { symbol: "Co", name: "Cobalt", isotopes: ["59Co"] },
            { symbol: "Ni", name: "Nickel", isotopes: ["58Ni", "60Ni", "61Ni", "62Ni", "64Ni"] },
            { symbol: "Cu", name: "Copper", isotopes: ["63Cu", "65Cu"] },
            { symbol: "Zn", name: "Zinc", isotopes: ["64Zn", "66Zn", "67Zn", "68Zn", "70Zn"] },
            { symbol: "Ga", name: "Gallium", isotopes: ["69Ga", "71Ga"] },
            { symbol: "Ge", name: "Germanium", isotopes: ["70Ge", "72Ge", "73Ge", "74Ge", "76Ge"] },
            { symbol: "As", name: "Arsenic", isotopes: ["75As"] },
            { symbol: "Se", name: "Selenium", isotopes: ["74Se", "76Se", "77Se", "78Se", "80Se", "82Se"] },
            { symbol: "Br", name: "Bromine", isotopes: ["79Br", "81Br"] },
            { symbol: "Kr", name: "Krypton", isotopes: ["78Kr", "80Kr", "82Kr", "83Kr", "84Kr", "86Kr"] },
            { symbol: "Rb", name: "Rubidium", isotopes: ["85Rb", "87Rb"] },
            { symbol: "Sr", name: "Strontium", isotopes: ["84Sr", "86Sr", "87Sr", "88Sr"] },
            { symbol: "Y", name: "Yttrium", isotopes: ["89Y"] },
            { symbol: "Zr", name: "Zirconium", isotopes: ["90Zr", "91Zr", "92Zr", "94Zr", "96Zr"] },
            { symbol: "Nb", name: "Niobium", isotopes: ["93Nb"] },
            { symbol: "Mo", name: "Molybdenum", isotopes: ["92Mo", "94Mo", "95Mo", "96Mo", "97Mo", "98Mo", "100Mo"] },
            { symbol: "Tc", name: "Technetium", isotopes: ["98Tc"] }, // Most stable isotope
            { symbol: "Ru", name: "Ruthenium", isotopes: ["96Ru", "98Ru", "99Ru", "100Ru", "101Ru", "102Ru", "104Ru"] },
            { symbol: "Rh", name: "Rhodium", isotopes: ["103Rh"] },
            { symbol: "Pd", name: "Palladium", isotopes: ["102Pd", "104Pd", "105Pd", "106Pd", "108Pd", "110Pd"] },
            { symbol: "Ag", name: "Silver", isotopes: ["107Ag", "109Ag"] },
            { symbol: "Cd", name: "Cadmium", isotopes: ["106Cd", "108Cd", "110Cd", "111Cd", "112Cd", "113Cd", "114Cd", "116Cd"] },
            { symbol: "In", name: "Indium", isotopes: ["113In", "115In"] },
            { symbol: "Sn", name: "Tin", isotopes: ["112Sn", "114Sn", "115Sn", "116Sn", "117Sn", "118Sn", "119Sn", "120Sn", "122Sn", "124Sn"] },
            { symbol: "Sb", name: "Antimony", isotopes: ["121Sb", "123Sb"] },
            { symbol: "Te", name: "Tellurium", isotopes: ["120Te", "122Te", "123Te", "124Te", "125Te", "126Te", "128Te", "130Te"] },
            { symbol: "I", name: "Iodine", isotopes: ["127I"] },
            { symbol: "Xe", name: "Xenon", isotopes: ["124Xe", "126Xe", "128Xe", "129Xe", "130Xe", "131Xe", "132Xe", "134Xe", "136Xe"] },
            { symbol: "Cs", name: "Cesium", isotopes: ["133Cs"] },
            { symbol: "Ba", name: "Barium", isotopes: ["130Ba", "132Ba", "134Ba", "135Ba", "136Ba", "137Ba", "138Ba"] },
            { symbol: "La", name: "Lanthanum", isotopes: ["138La", "139La"] },
            { symbol: "Ce", name: "Cerium", isotopes: ["136Ce", "138Ce", "140Ce", "142Ce"] },
            { symbol: "Pr", name: "Praseodymium", isotopes: ["141Pr"] },
            { symbol: "Nd", name: "Neodymium", isotopes: ["142Nd", "143Nd", "144Nd", "145Nd", "146Nd", "148Nd", "150Nd"] },
            { symbol: "Pm", name: "Promethium", isotopes: ["145Pm"] }, // Most stable isotope
            { symbol: "Sm", name: "Samarium", isotopes: ["144Sm", "147Sm", "148Sm", "149Sm", "150Sm", "152Sm", "154Sm"] },
            { symbol: "Eu", name: "Europium", isotopes: ["151Eu", "153Eu"] },
            { symbol: "Gd", name: "Gadolinium", isotopes: ["152Gd", "154Gd", "155Gd", "156Gd", "157Gd", "158Gd", "160Gd"] },
            { symbol: "Tb", name: "Terbium", isotopes: ["159Tb"] },
            { symbol: "Dy", name: "Dysprosium", isotopes: ["156Dy", "158Dy", "160Dy", "161Dy", "162Dy", "163Dy", "164Dy"] },
            { symbol: "Ho", name: "Holmium", isotopes: ["165Ho"] },
            { symbol: "Er", name: "Erbium", isotopes: ["162Er", "164Er", "166Er", "167Er", "168Er", "170Er"] },
            { symbol: "Tm", name: "Thulium", isotopes: ["169Tm"] },
            { symbol: "Yb", name: "Ytterbium", isotopes: ["168Yb", "170Yb", "171Yb", "172Yb", "173Yb", "174Yb", "176Yb"] },
            { symbol: "Lu", name: "Lutetium", isotopes: ["175Lu", "176Lu"] },
            { symbol: "Hf", name: "Hafnium", isotopes: ["174Hf", "176Hf", "177Hf", "178Hf", "179Hf", "180Hf"] },
            { symbol: "Ta", name: "Tantalum", isotopes: ["180mTa", "181Ta"] },
            { symbol: "W", name: "Tungsten", isotopes: ["180W", "182W", "183W", "184W", "186W"] },
            { symbol: "Re", name: "Rhenium", isotopes: ["185Re", "187Re"] },
            { symbol: "Os", name: "Osmium", isotopes: ["184Os", "186Os", "187Os", "188Os", "189Os", "190Os", "192Os"] },
            { symbol: "Ir", name: "Iridium", isotopes: ["191Ir", "193Ir"] },
            { symbol: "Pt", name: "Platinum", isotopes: ["190Pt", "192Pt", "194Pt", "195Pt", "196Pt", "198Pt"] },
            { symbol: "Au", name: "Gold", isotopes: ["197Au"] },
            { symbol: "Hg", name: "Mercury", isotopes: ["196Hg", "198Hg", "199Hg", "200Hg", "201Hg", "202Hg", "204Hg"] },
            { symbol: "Tl", name: "Thallium", isotopes: ["203Tl", "205Tl"] },
            { symbol: "Pb", name: "Lead", isotopes: ["204Pb", "206Pb", "207Pb", "208Pb"] },
            { symbol: "Bi", name: "Bismuth", isotopes: ["209Bi"] },
            { symbol: "Po", name: "Polonium", isotopes: ["209Po"] }, // Most stable isotope
            { symbol: "At", name: "Astatine", isotopes: ["210At"] }, // Most stable isotope
            { symbol: "Rn", name: "Radon", isotopes: ["222Rn"] }, // Most stable isotope
            { symbol: "Fr", name: "Francium", isotopes: ["223Fr"] }, // Most stable isotope
            { symbol: "Ra", name: "Radium", isotopes: ["226Ra"] }, // Most stable isotope
            { symbol: "Ac", name: "Actinium", isotopes: ["227Ac"] }, // Most stable isotope
            { symbol: "Th", name: "Thorium", isotopes: ["232Th"] },
            { symbol: "Pa", name: "Protactinium", isotopes: ["231Pa"] },
            { symbol: "U", name: "Uranium", isotopes: ["233U", "234U", "235U", "236U", "238U"] },
            { symbol: "Np", name: "Neptunium", isotopes: ["237Np"] },
            { symbol: "Pu", name: "Plutonium", isotopes: ["238Pu", "239Pu", "240Pu", "241Pu", "242Pu", "244Pu"] },
            { symbol: "Am", name: "Americium", isotopes: ["241Am", "243Am"] },
            { symbol: "Cm", name: "Curium", isotopes: ["242Cm", "244Cm", "245Cm", "246Cm", "247Cm", "248Cm"] },
            { symbol: "Bk", name: "Berkelium", isotopes: ["247Bk"] },
            { symbol: "Cf", name: "Californium", isotopes: ["249Cf", "250Cf", "251Cf", "252Cf"] },
            { symbol: "Es", name: "Einsteinium", isotopes: ["252Es"] },
            { symbol: "Fm", name: "Fermium", isotopes: ["257Fm"] },
            { symbol: "Md", name: "Mendelevium", isotopes: ["258Md"] },
            { symbol: "No", name: "Nobelium", isotopes: ["259No"] },
            { symbol: "Lr", name: "Lawrencium", isotopes: ["262Lr"] }
        ];

        // Modal functions
        function showModal(modalId, message = '') {
            if (message) {
                document.getElementById('modalMessage').innerText = message;
            }
            document.getElementById(modalId).style.display = 'flex';
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Function to handle login
        async function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');

            // Simple client-side authentication for demonstration
            if (username === 'admin' && password === 'password123') {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loginError.classList.add('hidden');
                await initializeGoogleSheet(); // Initialize Google Sheet on login
                addSampleRequest(); // Ensure this is called only once after successful login
                await renderTrackSamplesTable(); // Render tables after login
                await renderViewDataTable();
            } else {
                loginError.classList.remove('hidden');
            }
        }

        // Function to initialize Google Sheet by calling Apps Script
        async function initializeGoogleSheet() {
            try {
                const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'initialize',
                        data: JSON.stringify({}) // No specific data needed for initialization
                    })
                });
                const result = await response.json();
                if (result.success) {
                    console.log("Google Sheet initialized:", result.data);
                    // showModal("Google Sheet initialized successfully!"); // Suppress this on initial load
                } else {
                    console.error("Error initializing Google Sheet:", result.error);
                    showModal('messageModal', "Error initializing Google Sheet: " + result.error);
                }
            } catch (error) {
                console.error("Network error during Google Sheet initialization:", error);
                showModal('messageModal', "Network error during Google Sheet initialization. Check console for details.");
            }
        }

        // JavaScript for tab functionality (kept as is)
        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.add("hidden");
                tabcontent[i].classList.remove("active");
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.remove("hidden");
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");

            // Refresh data when switching to Track Samples or View Data tabs
            if (tabName === 'trackSamples') {
                refreshTrackSamples();
            } else if (tabName === 'viewData') {
                refreshViewData();
            }
        }

        // Function to add a new sample request block
        function addSampleRequest() {
            sampleCounter++;
            const container = document.getElementById('sampleRequestsContainer');
            const newBlock = document.createElement('div');
            newBlock.id = `sample-block-${sampleCounter}`;
            newBlock.classList.add('sample-request-block');
            newBlock.innerHTML = `
                <button type="button" class="remove-button" onclick="removeSampleRequest('sample-block-${sampleCounter}')">Remove</button>
                <h3 class="text-xl font-semibold mb-4 mit-blue">Sample #${sampleCounter} Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label for="sampleId-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Sample ID:</label>
                        <input type="text" id="sampleId-${sampleCounter}" name="sampleId" placeholder="e.g., S-001" required>
                    </div>
                    <div class="form-group">
                        <label for="materialForm-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Material Form:</label>
                        <select id="materialForm-${sampleCounter}" name="materialForm" required>
                            <option value="">Select Form</option>
                            <option value="Powder">Powder</option>
                            <option value="Solid">Solid</option>
                            <option value="Liquid">Liquid</option>
                            <option value="Gas">Gas</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="materialName-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Material Name (Element):</label>
                        <select id="materialName-${sampleCounter}" name="materialName" onchange="updateIsotopes(${sampleCounter})" required>
                            <option value="">Select Element</option>
                            ${periodicElements.map(element => `<option value="${element.symbol}">${element.name} (${element.symbol})</option>`).join('')}
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="materialIsotope-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Material Isotope (if applicable):</label>
                        <select id="materialIsotope-${sampleCounter}" name="materialIsotope">
                            <option value="">Select Isotope</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="mass-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Mass (g):</label>
                        <input type="number" id="mass-${sampleCounter}" name="mass" step="any" placeholder="e.g., 10.5">
                    </div>
                    <div class="form-group">
                        <label for="volume-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Volume (mL):</label>
                        <input type="number" id="volume-${sampleCounter}" name="volume" step="any" placeholder="e.g., 5.2">
                    </div>
                    <div class="form-group">
                        <label for="density-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Density (g/cmÂ³):</label>
                        <input type="number" id="density-${sampleCounter}" name="density" step="any" placeholder="e.g., 7.87">
                    </div>
                    <div class="form-group">
                        <label for="purity-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Purity (%):</label>
                        <input type="number" id="purity-${sampleCounter}" name="purity" step="any" min="0" max="100" placeholder="e.g., 99.9">
                    </div>
                    <div class="form-group col-span-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Composition (for alloys/mixtures):</label>
                        <table class="composition-table" id="composition-table-${sampleCounter}">
                            <thead>
                                <tr>
                                    <th>Element</th>
                                    <th>Percentage (%)</th>
                                    <th>Action</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                        <button type="button" onclick="addCompositionRow(${sampleCounter})" class="mt-2 mit-light-blue-bg text-mit-blue py-2 px-4 rounded-md text-sm hover:opacity-90 transition duration-300">Add Element</button>
                    </div>
                    <div class="form-group">
                        <label for="experimentType-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Experiment Type:</label>
                        <select id="experimentType-${sampleCounter}" name="experimentType" required>
                            <option value="">Select Experiment Type</option>
                            <option value="Irradiation">Irradiation</option>
                            <option value="Post-Irradiation Examination (PIE)">Post-Irradiation Examination (PIE)</option>
                            <option value="Material Characterization">Material Characterization</option>
                            <option value="Fuel Development">Fuel Development</option>
                            <option value="Corrosion Study">Corrosion Study</option>
                            <option value="Thermal Properties">Thermal Properties</option>
                            <option value="Mechanical Testing">Mechanical Testing</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="requestedDate-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Requested Completion Date:</label>
                        <input type="date" id="requestedDate-${sampleCounter}" name="requestedDate" required>
                    </div>
                    <div class="form-group col-span-full">
                        <label for="specialInstructionsSample-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Special Instructions for this Sample:</label>
                        <textarea id="specialInstructionsSample-${sampleCounter}" name="specialInstructionsSample" rows="3" placeholder="Any specific requirements or details for this sample..."></textarea>
                    </div>
                </div>
            `;
            container.appendChild(newBlock);
            addCompositionRow(sampleCounter); // Add an initial composition row
        }

        // Function to remove a sample request block
        function removeSampleRequest(blockId) {
            const block = document.getElementById(blockId);
            if (block) {
                block.remove();
            }
        }

        // Function to update isotopes dropdown based on selected element
        function updateIsotopes(sampleNum) {
            const materialNameSelect = document.getElementById(`materialName-${sampleNum}`);
            const materialIsotopeSelect = document.getElementById(`materialIsotope-${sampleNum}`);
            const selectedElementSymbol = materialNameSelect.value;

            // Clear existing options
            materialIsotopeSelect.innerHTML = '<option value="">Select Isotope</option>';

            if (selectedElementSymbol) {
                const element = periodicElements.find(el => el.symbol === selectedElementSymbol);
                if (element && element.isotopes) {
                    element.isotopes.forEach(isotope => {
                        const option = document.createElement('option');
                        option.value = isotope;
                        option.textContent = isotope;
                        materialIsotopeSelect.appendChild(option);
                    });
                }
            }
        }

        // Function to add a row to the composition table
        function addCompositionRow(sampleNum) {
            const tableBody = document.querySelector(`#composition-table-${sampleNum} tbody`);
            const newRow = document.createElement('tr');
            const rowId = `composition-row-${sampleNum}-${tableBody.children.length}`;
            newRow.id = rowId;
            newRow.innerHTML = `
                <td>
                    <select name="compositionElement" class="w-full p-2 border border-gray-300 rounded-md">
                        <option value="">Select Element</option>
                        ${periodicElements.map(element => `<option value="${element.symbol}">${element.name} (${element.symbol})</option>`).join('')}
                    </select>
                </td>
                <td>
                    <input type="number" name="compositionPercentage" step="any" min="0" max="100" placeholder="e.g., 50" class="w-full p-2 border border-gray-300 rounded-md">
                </td>
                <td>
                    <button type="button" onclick="removeCompositionRow('${rowId}')" class="text-red-500 hover:text-red-700 text-sm font-bold">Remove</button>
                </td>
            `;
            tableBody.appendChild(newRow);
        }

        // Function to remove a row from the composition table
        function removeCompositionRow(rowId) {
            const row = document.getElementById(rowId);
            if (row) {
                row.remove();
            }
        }

        // Event listener for the main sample request form submission
        document.getElementById('sampleRequestForm').addEventListener('submit', async function(event) {
            event.preventDefault(); // Prevent default form submission

            const collaboratorName = document.getElementById('collaboratorName').value;
            const collaboratorCompany = document.getElementById('collaboratorCompany').value;
            const collaboratorEmail = document.getElementById('collaboratorEmail').value;
            const collaboratorPhone = document.getElementById('collaboratorPhone').value;
            const lotNumber = document.getElementById('lotNumber').value;
            const generalSpecialInstructions = document.getElementById('generalSpecialInstructions').value;

            const samples = [];
            const sampleBlocks = document.querySelectorAll('.sample-request-block');

            sampleBlocks.forEach(block => {
                const sampleId = block.querySelector('[name="sampleId"]').value;
                const materialForm = block.querySelector('[name="materialForm"]').value;
                const materialName = block.querySelector('[name="materialName"]').value;
                const materialIsotope = block.querySelector('[name="materialIsotope"]').value;
                const mass = block.querySelector('[name="mass"]').value;
                const volume = block.querySelector('[name="volume"]').value;
                const density = block.querySelector('[name="density"]').value;
                const purity = block.querySelector('[name="purity"]').value;
                const experimentType = block.querySelector('[name="experimentType"]').value;
                const requestedDate = block.querySelector('[name="requestedDate"]').value;
                const specialInstructionsSample = block.querySelector('[name="specialInstructionsSample"]').value;

                const composition = {};
                block.querySelectorAll('.composition-table tbody tr').forEach(row => {
                    const element = row.querySelector('[name="compositionElement"]').value;
                    const percentage = row.querySelector('[name="compositionPercentage"]').value;
                    if (element && percentage) {
                        composition[element] = parseFloat(percentage);
                    }
                });

                samples.push({
                    sampleId,
                    materialForm,
                    materialName,
                    materialIsotope,
                    mass: mass ? parseFloat(mass) : null,
                    volume: volume ? parseFloat(volume) : null,
                    density: density ? parseFloat(density) : null,
                    purity: purity ? parseFloat(purity) : null,
                    composition,
                    experimentType,
                    requestedDate,
                    specialInstructionsSample
                });
            });

            const formData = {
                collaboratorName,
                collaboratorCompany,
                collaboratorEmail,
                collaboratorPhone,
                lotNumber,
                generalSpecialInstructions,
                samples
            };

            try {
                const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'submitSampleRequest',
                        data: JSON.stringify(formData)
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showModal('messageModal', "Sample requests submitted successfully! An email confirmation has been sent.");
                    document.getElementById('sampleRequestForm').reset(); // Clear form
                    document.getElementById('sampleRequestsContainer').innerHTML = ''; // Clear dynamic blocks
                    sampleCounter = 0; // Reset counter
                    addSampleRequest(); // Add one fresh block
                    await refreshTrackSamples(); // Refresh tracking table
                } else {
                    showModal('messageModal', "Error submitting requests: " + result.error);
                }
            } catch (error) {
                console.error("Network error during submission:", error);
                showModal('messageModal', "Network error during submission. Check console for details.");
            }
        });

        // Function to render the track samples table
        async function renderTrackSamplesTable() {
            const tableBody = document.getElementById('sampleTrackingTableBody');
            tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4">Loading tracking data...</td></tr>'; // Adjusted colspan

            try {
                const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'getSampleRequests', // Get all requests to show status
                        data: JSON.stringify({})
                    })
                });
                const result = await response.json();

                if (result.success) {
                    const allRequests = result.data;

                    const trackingResponse = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            action: 'getSampleTracking', // Get tracking numbers
                            data: JSON.stringify({})
                        })
                    });
                    const trackingResult = await trackingResponse.json();
                    const allTracking = trackingResult.success ? trackingResult.data : [];

                    tableBody.innerHTML = ''; // Clear loading message

                    if (allRequests.length === 0) {
                        tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-4">No sample requests submitted yet.</td></tr>'; // Adjusted colspan
                        return;
                    }

                    allRequests.forEach(sample => {
                        const trackingInfo = allTracking.find(track =>
                            track["Lot Number"] === sample["Lot Number"] &&
                            track["Sample ID"] === sample["Sample ID"]
                        );
                        const trackingNumber = trackingInfo ? trackingInfo["Tracking Number"] : 'N/A';

                        const row = document.createElement('tr');
                        row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-50');
                        row.innerHTML = `
                            <td class="py-3 px-4">${sample["Lot Number"]}</td>
                            <td class="py-3 px-4">${sample["Sample ID"]}</td>
                            <td class="py-3 px-4">${sample["Material Name"]} (${sample["Material Isotope"] || 'N/A'})</td>
                            <td class="py-3 px-4">${sample["Experiment Type"]}</td>
                            <td class="py-3 px-4">${sample["Status"]}</td>
                            <td class="py-3 px-4">${sample["Approval Date"] ? new Date(sample["Approval Date"]).toLocaleDateString() : 'Pending'}</td>
                            <td class="py-3 px-4">${sample["Shipping Instructions"] || 'Pending'}</td>
                            <td class="py-3 px-4">${trackingNumber}</td>
                            <td class="py-3 px-4">
                                <button type="button" onclick="openAddTrackingModal('${sample["Lot Number"]}', '${sample["Sample ID"]}')" class="mit-blue-bg text-white py-1 px-3 rounded-md text-sm hover:opacity-90">Add Tracking</button>
                            </td>
                        `;
                        tableBody.appendChild(row);
                    });
                } else {
                    tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-red-600">Error loading tracking data: ${result.error}</td></tr>`; // Adjusted colspan
                    console.error("Error loading tracking data:", result.error);
                }
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-4 text-red-600">Network error loading tracking data.</td></tr>`; // Adjusted colspan
                console.error("Network error loading tracking data:", error);
            }
        }

        // Function to refresh track samples data
        async function refreshTrackSamples() {
            await renderTrackSamplesTable();
        }

        // Function to open the Add Tracking Modal
        function openAddTrackingModal(lotNumber, sampleId) {
            document.getElementById('modalTrackingLotNumber').value = lotNumber;
            document.getElementById('modalTrackingSampleId').value = sampleId;
            document.getElementById('modalTrackingNumber').value = ''; // Clear previous input
            document.getElementById('modalTrackingDate').value = ''; // Clear previous input
            document.getElementById('modalTrackingNotes').value = ''; // Clear previous input
            showModal('addTrackingModal');
        }

        // Function to handle submitting tracking details from the modal
        async function submitTrackingDetails() {
            const lotNumber = document.getElementById('modalTrackingLotNumber').value;
            const sampleId = document.getElementById('modalTrackingSampleId').value;
            const trackingNumber = document.getElementById('modalTrackingNumber').value;
            const trackingDate = document.getElementById('modalTrackingDate').value;
            const notes = document.getElementById('modalTrackingNotes').value;

            if (!trackingNumber || !trackingDate) {
                showModal('messageModal', "Please enter both Tracking Number and Tracking Date.");
                return;
            }

            const trackingData = {
                lotNumber,
                sampleId,
                trackingNumber,
                trackingDate,
                notes
            };

            try {
                const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'addTrackingDetails',
                        data: JSON.stringify(trackingData)
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showModal('messageModal', "Tracking details added successfully! Email sent.");
                    closeModal('addTrackingModal');
                    await refreshTrackSamples(); // Refresh the table to show updated tracking
                } else {
                    showModal('messageModal', "Error adding tracking details: " + result.error);
                }
            } catch (error) {
                console.error("Network error during adding tracking details:", error);
                showModal('messageModal', "Network error during adding tracking details. Check console for details.");
            }
        }

        // Function to render the view data table
        async function renderViewDataTable() {
            const tableBody = document.getElementById('sampleDataTableBody');
            tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">Loading sample data...</td></tr>'; // Adjusted colspan

            try {
                const requestsResponse = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'getSampleRequests',
                        data: JSON.stringify({})
                    })
                });
                const requestsResult = await requestsResponse.json();
                const allRequests = requestsResult.success ? requestsResult.data : [];

                const dataResponse = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'getSampleData',
                        data: JSON.stringify({})
                    })
                });
                const dataResult = await dataResponse.json();
                const allSampleData = dataResult.success ? dataResult.data : [];

                tableBody.innerHTML = ''; // Clear loading message

                if (allRequests.length === 0) {
                    tableBody.innerHTML = '<tr><td colspan="6" class="text-center py-4">No sample data available yet.</td></tr>'; // Adjusted colspan
                    return;
                }

                allRequests.forEach(sample => {
                    const sampleDataEntry = allSampleData.find(data =>
                        data["Lot Number"] === sample["Lot Number"] &&
                        data["Sample ID"] === sample["Sample ID"]
                    );

                    const dataAvailable = sampleDataEntry ? (sampleDataEntry["Data Available"] || 'No') : 'No';
                    const lastUpdatedDate = sampleDataEntry ? (sampleDataEntry["Last Updated Date"] ? new Date(sampleDataEntry["Last Updated Date"]).toLocaleDateString() : 'N/A') : 'N/A';
                    const dataLink = sampleDataEntry ? (sampleDataEntry["Data Link"] || '#') : '#';

                    const row = document.createElement('tr');
                    row.classList.add('border-b', 'border-gray-200', 'hover:bg-gray-50');
                    row.innerHTML = `
                        <td class="py-3 px-4">${sample["Lot Number"]}</td>
                        <td class="py-3 px-4">${sample["Sample ID"]}</td>
                        <td class="py-3 px-4">${sample["Experiment Type"]}</td>
                        <td class="py-3 px-4">${lastUpdatedDate}</td>
                        <td class="py-3 px-4">
                            ${dataAvailable === 'Yes' ? `<a href="${dataLink}" target="_blank" class="text-green-600 hover:underline">View Data</a>` : dataAvailable}
                        </td>
                        <td class="py-3 px-4">
                            <button type="button" onclick="openRequestDataModal('${sample["Lot Number"]}', '${sample["Sample ID"]}')" class="mit-blue-bg text-white py-1 px-3 rounded-md text-sm hover:opacity-90">Request Data</button>
                        </td>
                    `;
                    tableBody.appendChild(row);
                });
            } catch (error) {
                tableBody.innerHTML = `<tr><td colspan="6" class="text-center py-4 text-red-600">Network error loading sample data.</td></tr>`; // Adjusted colspan
                console.error("Network error loading sample data:", error);
            }
        }

        // Function to refresh view data
        async function refreshViewData() {
            await renderViewDataTable();
        }

        // Function to open the Request Data Modal
        function openRequestDataModal(lotNumber, sampleId) {
            document.getElementById('modalRequestDataLotNumber').innerText = lotNumber;
            document.getElementById('modalRequestDataSampleId').innerText = sampleId;
            document.getElementById('modalRequestDataType').value = 'Individual Sample Data'; // Reset to default
            showModal('requestDataModal');
        }

        // Function to handle submitting data request from the modal
        async function submitRequestData() {
            const lotNumber = document.getElementById('modalRequestDataLotNumber').innerText;
            const sampleId = document.getElementById('modalRequestDataSampleId').innerText;
            const requestType = document.getElementById('modalRequestDataType').value;

            const requestDataPayload = {
                lotNumber,
                sampleId,
                requestType
            };

            try {
                const response = await fetch(GOOGLE_SHEET_WEB_APP_URL, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        action: 'requestData',
                        data: JSON.stringify(requestDataPayload)
                    })
                });
                const result = await response.json();

                if (result.success) {
                    showModal('messageModal', "Data request submitted successfully! An email notification has been sent.");
                    closeModal('requestDataModal');
                    await refreshViewData(); // Refresh the table to show updated status
                } else {
                    showModal('messageModal', "Error requesting data: " + result.error);
                }
            } catch (error) {
                console.error("Network error during data request:", error);
                showModal('messageModal', "Network error during data request. Check console for details.");
            }
        }

        // Initial calls when the page loads
        document.addEventListener('DOMContentLoaded', () => {
            // No initial calls here, as they are triggered after successful login.
            // The addSampleRequest() is called in handleLogin() after successful login.
        });
    </script>
</body>
</html>
