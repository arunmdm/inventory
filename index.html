<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIT- Nuclear Innovations Fission Technology Sample Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #1f2937;
        }
        /* MIT Blue for headings and active elements */
        .mit-blue {
            color: #005A9C; /* MIT Blue */
        }
        .mit-blue-bg {
            background-color: #005A9C; /* MIT Blue */
        }
        .mit-light-blue-bg {
            background-color: #ADD8E6; /* Light Blue, can be used for secondary elements */
        }
        .mit-orange {
            color: #E66C00; /* MIT Orange, for accents or warnings */
        }
        .mit-red {
            color: #A31F34; /* MIT Red, for errors or destructive actions */
        }
        .mit-green {
            color: #6C9F3E; /* MIT Green, for success */
        }

        /* General input styling */
        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        input[type="password"],
        select,
        textarea {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #d1d5db;
            border-radius: 0.375rem;
            outline: none;
        }
        input:focus, select:focus, textarea:focus {
            border-color: #005A9C;
            box-shadow: 0 0 0 2px rgba(0, 90, 156, 0.2);
        }
        /* Button styling */
        button {
            padding: 0.75rem 1.5rem;
            border-radius: 0.375rem;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
        }
        .tab-button.active {
            background-color: #005A9C;
            color: white;
        }
        .tab-button:not(.active) {
            background-color: #e5e7eb;
            color: #374151;
        }
        .tab-button:not(.active):hover {
            background-color: #d1d5db;
        }

        /* Inline form specific styles for data request */
        .inline-data-request-form-container {
            background-color: #f9fafb;
            padding: 1.5rem;
            border-top: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
        }
        .inline-data-request-form-container .form-group {
            margin-bottom: 1rem;
        }

        /* Styles for dynamic sample request blocks */
        .sample-request-block {
            border: 1px solid #e5e7eb;
            padding: 1.5rem;
            border-radius: 0.5rem;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            background-color: white;
            margin-bottom: 1.5rem;
            position: relative;
        }
        .sample-request-block .remove-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            color: #dc2626;
            font-weight: bold;
            font-size: 0.875rem;
            background: none;
            border: none;
            padding: 0.25rem 0.5rem;
        }
        .sample-request-block .remove-button:hover {
            color: #b91c1c;
        }

        /* Login page specific styles */
        .login-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background-color: #f3f4f6;
        }
        .login-card {
            background-color: white;
            padding: 2rem;
            border-radius: 0.5rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
            width: 100%;
            max-width: 28rem;
        }
        .error-message {
            color: #dc2626;
            text-align: center;
            margin-bottom: 1rem;
        }
        /* Style for lot number header in tables */
        .lot-header {
            background-color: #dbeafe;
            color: #1e40af;
            font-weight: bold;
            font-size: 1.125rem;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #bfdbfe;
        }
        .tracking-input-row-dynamic, .lot-data-request-row-dynamic {
            background-color: #f9fafb;
        }
    </style>
</head>
<body>
    <div id="loginPage" class="login-container">
        <div class="login-card">
            <h2 class="text-2xl font-bold text-center mb-6 mit-blue">Login to MIT Nuclear Innovations Fission Technology Sample Management</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username:</label>
                    <input type="text" id="username" name="username" placeholder="admin" required>
                </div>
                <div class="form-group mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password:</label>
                    <input type="password" id="password" name="password" placeholder="password123" required>
                </div>
                <p id="loginError" class="error-message hidden">Invalid username or password.</p>
                <button type="submit" class="mit-blue-bg text-white w-full py-3 rounded-md hover:opacity-90 transition duration-300" id="loginButton">Login</button>
            </form>
        </div>
    </div>

    <div id="mainContent" class="container mx-auto p-6 md:p-10 bg-white shadow-lg rounded-lg my-8 max-w-4xl hidden">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 mit-blue">MIT- Nuclear Innovations Fission Technology Sample Management System</h1>

        <div class="flex flex-wrap justify-center mb-8 border-b-2 border-gray-200">
            <button class="tab-button py-3 px-6 rounded-t-lg text-lg font-medium transition-colors duration-300 active" onclick="openTab(event, 'requestSample')">Request Sample</button>
            <button class="tab-button py-3 px-6 rounded-t-lg text-lg font-medium transition-colors duration-300" onclick="openTab(event, 'trackSamples')">Track Samples</button>
            <button class="tab-button py-3 px-6 rounded-t-lg text-lg font-medium transition-colors duration-300" onclick="openTab(event, 'viewData')">View Sample Data</button>
        </div>

        <div id="requestSample" class="tab-content active">
            <h2 class="text-2xl font-semibold mb-6 mit-blue">Submit a New Sample Request</h2>
            <p class="text-gray-600 mb-6">Fill out the form below to submit new sample requests. Remember to specify details for each sample and provide a unique Lot Number for the batch. Click "Add Another Sample" to include multiple samples under the same lot.</p>
            <form id="sampleRequestForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="text-xl font-semibold col-span-full mit-blue mb-4">Collaborator Information</h3>
                    <div class="form-group">
                        <label for="collaboratorName" class="block text-sm font-medium text-gray-700 mb-2">Name:</label>
                        <input type="text" id="collaboratorName" name="collaboratorName" placeholder="John Doe" required>
                    </div>
                    <div class="form-group">
                        <label for="collaboratorCompany" class="block text-sm font-medium text-gray-700 mb-2">Company:</label>
                        <input type="text" id="collaboratorCompany" name="collaboratorCompany" placeholder="e.g., MIT, Acme Materials Inc." required>
                    </div>
                    <div class="form-group">
                        <label for="collaboratorEmail" class="block text-sm font-medium text-gray-700 mb-2">Email:</label>
                        <input type="email" id="collaboratorEmail" name="collaboratorEmail" placeholder="johndoe@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="collaboratorPhone" class="block text-sm font-medium text-gray-700 mb-2">Phone (Optional):</label>
                        <input type="text" id="collaboratorPhone" name="collaboratorPhone" placeholder="e.g., +1-123-456-7890">
                    </div>
                </div>

                <div class="form-group mb-6 p-6 bg-yellow-50 rounded-lg border border-yellow-200">
                    <label for="lotNumber" class="block text-sm font-medium text-gray-700 mb-2">Lot Number (for this batch of samples):</label>
                    <input type="text" id="lotNumber" name="lotNumber" placeholder="e.g., LOT-2025-001" required>
                </div>

                <div id="sampleRequestsContainer"></div>

                <div class="flex justify-center mt-6 mb-8">
                    <button type="button" onclick="addSampleRequest()" class="bg-green-600 hover:bg-green-700 text-white py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Add Another Sample
                    </button>
                </div>

                <div class="form-group col-span-1 md:col-span-2">
                    <label for="generalSpecialInstructions" class="block text-sm font-medium text-gray-700 mb-2">General Special Instructions for All Samples:</label>
                    <textarea id="generalSpecialInstructions" name="generalSpecialInstructions" rows="4" placeholder="Any overall requirements or details not covered above for all samples..."></textarea>
                </div>

                <div class="form-group col-span-1 md:col-span-2 text-center mt-8">
                    <button type="submit" class="mit-blue-bg hover:opacity-90 text-white py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out">Submit All Requests</button>
                </div>
            </form>
        </div>

        <div id="trackSamples" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 mit-blue">Track Your Sample Requests</h2>
            <p class="text-gray-600 mb-6">Monitor the status of your submitted samples here, grouped by Lot Number. Once approved, you'll find shipping instructions. Use the 'Add Tracking Details' button for each lot to enter tracking numbers when available. You will receive an approval email with further instructions.</p>
            <div class="flex justify-end mb-4">
                <button type="button" onclick="refreshTrackSamples()" class="mit-blue-bg hover:opacity-90 text-white py-2 px-5 rounded-md flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004 10.59V10m5-3.54l-3 3m0 0l3 3m-3-3H2m14 2.5v4h.582m-15.356-2A8.001 8.001 0 0120 13.41V14m-5 3.54l3-3m0 0l-3-3m3 3H22"></path></svg>
                    Refresh
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-md">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-md">Sample ID</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Material</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Experiment Type</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Approval Date</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Shipping Instructions</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-md">Tracking Number</th>
                        </tr>
                    </thead>
                    <tbody id="sampleTrackingTableBody"></tbody>
                </table>
            </div>
        </div>

        <div id="viewData" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 mit-blue">View Sample Data</h2>
            <p class="text-gray-600 mb-6">Access data for your completed samples here, grouped by Lot Number. You can request data for individual samples or for an entire lot. Note that requesting data for an entire lot might take longer; consider requesting specific samples for a faster response. You will receive an email if new updates are made to the sample.</p>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-md">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-md">Sample ID</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Experiment Type</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Last Updated Date</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Request Data</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-md">Data Available</th>
                        </tr>
                    </thead>
                    <tbody id="sampleDataTableBody"></tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let sampleCounter = 0;
        let allSamplesData = [];
        let compositionCounters = {};
        
        // REPLACE THIS WITH YOUR DEPLOYED GOOGLE APPS SCRIPT URL
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbxHDS5e4O99vvWV1eJ8mU4Cy3t0Kr9fs050k_uMkGIgnzMvXoqgfoIsZNOf5gr6ZMAkJA/exec';

        // Data for periodic table elements and their isotopes
        const periodicElements = [
            { symbol: "H", name: "Hydrogen", isotopes: ["1H", "2H", "3H"] },
            { symbol: "He", name: "Helium", isotopes: ["3He", "4He"] },
            { symbol: "Li", name: "Lithium", isotopes: ["6Li", "7Li"] },
            { symbol: "Be", name: "Beryllium", isotopes: ["9Be"] },
            { symbol: "B", name: "Boron", isotopes: ["10B", "11B"] },
            { symbol: "C", name: "Carbon", isotopes: ["12C", "13C", "14C"] },
            { symbol: "N", name: "Nitrogen", isotopes: ["14N", "15N"] },
            { symbol: "O", name: "Oxygen", isotopes: ["16O", "17O", "18O"] },
            { symbol: "F", name: "Fluorine", isotopes: ["19F"] },
            { symbol: "Ne", name: "Neon", isotopes: ["20Ne", "21Ne", "22Ne"] },
            { symbol: "Na", name: "Sodium", isotopes: ["23Na"] },
            { symbol: "Mg", name: "Magnesium", isotopes: ["24Mg", "25Mg", "26Mg"] },
            { symbol: "Al", name: "Aluminum", isotopes: ["27Al"] },
            { symbol: "Si", name: "Silicon", isotopes: ["28Si", "29Si", "30Si"] },
            { symbol: "P", name: "Phosphorus", isotopes: ["31P"] },
            { symbol: "S", name: "Sulfur", isotopes: ["32S", "33S", "34S", "36S"] },
            { symbol: "Cl", name: "Chlorine", isotopes: ["35Cl", "37Cl"] },
            { symbol: "Ar", name: "Argon", isotopes: ["36Ar", "38Ar", "40Ar"] },
            { symbol: "K", name: "Potassium", isotopes: ["39K", "40K", "41K"] },
            { symbol: "Ca", name: "Calcium", isotopes: ["40Ca", "42Ca", "43Ca", "44Ca", "46Ca", "48Ca"] },
            { symbol: "Fe", name: "Iron", isotopes: ["54Fe", "56Fe", "57Fe", "58Fe"] },
            { symbol: "Ni", name: "Nickel", isotopes: ["58Ni", "60Ni", "61Ni", "62Ni", "64Ni"] },
            { symbol: "Cu", name: "Copper", isotopes: ["63Cu", "65Cu"] },
            { symbol: "Zn", name: "Zinc", isotopes: ["64Zn", "66Zn", "67Zn", "68Zn", "70Zn"] },
            { symbol: "Zr", name: "Zirconium", isotopes: ["90Zr", "91Zr", "92Zr", "94Zr", "96Zr"] },
            { symbol: "U", name: "Uranium", isotopes: ["234U", "235U", "238U"] },
            { symbol: "Pu", name: "Plutonium", isotopes: ["238Pu", "239Pu", "240Pu", "241Pu", "242Pu", "244Pu"] }
        ];

        // Helper to map symbol to isotopes for easy lookup
        const isotopeMap = {};
        periodicElements.forEach(el => {
            isotopeMap[el.symbol] = el.isotopes;
        });

        // Enhanced login function with better error handling
        async function handleLogin(event) {
            event.preventDefault();
            
            const usernameInput = document.getElementById('username');
            const passwordInput = document.getElementById('password');
            const loginError = document.getElementById('loginError');
            const loginButton = document.getElementById('loginButton');

            // Show loading state
            loginButton.disabled = true;
            loginButton.textContent = 'Logging in...';
            loginError.classList.add('hidden');

            const payload = {
                type: 'login',
                username: usernameInput.value.trim(),
                password: passwordInput.value.trim()
            };

            console.log('Attempting login with:', { username: payload.username, password: '[HIDDEN]' });
            console.log('Sending to URL:', WEB_APP_URL);

            try {
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    throw new Error(`HTTP error! Status: ${response.status}`);
                }

                const result = await response.json();
                console.log('Login response:', result);

                if (result.success) {
                    console.log('Login successful, switching to main content');
                    document.getElementById('loginPage').classList.add('hidden');
                    document.getElementById('mainContent').classList.remove('hidden');
                    
                    // Initialize the application
                    addSampleRequest();
                    renderTrackSamplesTable();
                    renderViewDataTable();
                } else {
                    console.log('Login failed:', result.message);
                    loginError.classList.remove('hidden');
                    loginError.textContent = result.message || 'Login failed. Please try again.';
                }
            } catch (error) {
                console.error('Login error:', error);
                loginError.classList.remove('hidden');
                loginError.textContent = `Connection error: ${error.message}. Please check your network connection and try again.`;
            } finally {
                loginButton.disabled = false;
                loginButton.textContent = 'Login';
            }
        }

        // Enhanced data sending function with better error handling
        async function sendDataToGoogleAppsScript(payload) {
            try {
                console.log('Sending data:', payload);
                
                const response = await fetch(WEB_APP_URL, {
                    method: 'POST',
                    mode: 'cors',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify(payload),
                });

                console.log('Response status:', response.status);

                if (!response.ok) {
                    let errorMessage = `HTTP error! Status: ${response.status}`;
                    try {
                        const errorText = await response.text();
                        errorMessage += ` - Details: ${errorText}`;
                    } catch (e) {
                        // If response.text() fails, just use the status
                    }
                    console.error("Server responded with an error:", errorMessage);
                    return { success: false, message: `Server error: ${errorMessage}` };
                }

                const result = await response.json();
                console.log("Server response:", result);

                return result;
            } catch (error) {
                console.error("Network or fetch error:", error);
                return { 
                    success: false, 
                    message: `Network error: Could not connect to the server. Please check your internet connection. (Details: ${error.message})` 
                };
            }
        }

        // Function to generate a new sample request block HTML
        function generateSampleBlockHtml(index) {
            return `
                <div class="sample-request-block" data-sample-index="${index}">
                    <h3 class="text-xl font-semibold mb-4 text-gray-700">Sample #<span class="sample-index-display">${index + 1}</span></h3>
                    ${index > 0 ? `<button type="button" class="remove-button" onclick="removeSampleRequest(this)">Remove</button>` : ''}
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                        <div class="form-group">
                            <label for="sampleID-${index}" class="block text-sm font-medium text-gray-700 mb-2">Proposed Sample ID:</label>
                            <input type="text" id="sampleID-${index}" name="sampleID-${index}" placeholder="MIT-SAMPLE-XYZ" required>
                        </div>
                        <div class="form-group">
                            <label for="materialType-${index}" class="block text-sm font-medium text-gray-700 mb-2">Material Type:</label>
                            <input type="text" id="materialType-${index}" name="materialType-${index}" placeholder="Stainless Steel 316L" required>
                        </div>
                        <div class="form-group">
                            <label for="sampleShape-${index}" class="block text-sm font-medium text-gray-700 mb-2">Sample Shape:</label>
                            <select id="sampleShape-${index}" name="sampleShape-${index}" required onchange="handleShapeChangeForBlock(this, ${index})">
                                <option value="">Select a shape</option>
                                <option value="Cylinder">Cylinder</option>
                                <option value="Dogbone">Dogbone</option>
                                <option value="Disc">Disc</option>
                                <option value="Cube">Cube</option>
                                <option value="Plate">Plate</option>
                                <option value="Tubes">Tubes</option>
                                <option value="Bars">Bars</option>
                                <option value="Square Coupon">Square Coupon</option>
                                <option value="Sphere">Sphere</option>
                                <option value="Powder">Powder</option>
                                <option value="Liquid">Liquid</option>
                                <option value="Gas">Gas</option>
                                <option value="Cryo">Cryo</option>
                                <option value="Other">Other</option>
                            </select>
                        </div>
                        <div id="dimensionsContainer-${index}" class="form-group"></div>
                        <div class="form-group">
                            <label for="weight-${index}" class="block text-sm font-medium text-gray-700 mb-2">Weight (grams):</label>
                            <input type="number" id="weight-${index}" name="weight-${index}" placeholder="e.g., 5.2" step="any" required>
                        </div>
                    </div>

                    <div class="mt-6 p-4 bg-gray-50 rounded-md border border-gray-200">
                        <h4 class="text-lg font-semibold mb-3 text-gray-700">Sample Composition (Elemental/Isotopic)</h4>
                        <div id="compositionContainer-${index}"></div>
                        <button type="button" onclick="addCompositionEntry(${index})" class="mit-blue-bg hover:opacity-90 text-white px-4 py-2 rounded-md text-sm">Add Component</button>
                    </div>

                    <div class="form-group mt-6">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Intended Experiment Type:</label>
                        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-2">
                            <div class="flex flex-col">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="experimentType-${index}" value="Characterization" class="form-checkbox h-5 w-5 text-mit-blue rounded-md" onchange="toggleExperimentDetailsForBlock(this, ${index})">
                                    <span class="ml-2 text-gray-700">Characterization</span>
                                </label>
                                <textarea id="details-Characterization-${index}" class="hidden w-full p-2 border border-gray-300 rounded-md text-sm mt-1" rows="2" placeholder="Specify technique (e.g., SEM, TEM, XRD), areas of interest"></textarea>
                            </div>
                            <div class="flex flex-col">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="experimentType-${index}" value="Post Irradiation Examination" class="form-checkbox h-5 w-5 text-mit-blue rounded-md" onchange="toggleExperimentDetailsForBlock(this, ${index})">
                                    <span class="ml-2 text-gray-700">Post Irradiation Examination</span>
                                </label>
                                <textarea id="details-PostIrradiationExamination-${index}" class="hidden w-full p-2 border border-gray-300 rounded-md text-sm mt-1" rows="2" placeholder="Specify PIE details"></textarea>
                            </div>
                            <div class="flex flex-col">
                                <label class="inline-flex items-center">
                                    <input type="checkbox" name="experimentType-${index}" value="Other" class="form-checkbox h-5 w-5 text-mit-blue rounded-md" onchange="toggleExperimentDetailsForBlock(this, ${index})">
                                    <span class="ml-2 text-gray-700">Other</span>
                                </label>
                                <textarea id="details-Other-${index}" class="hidden w-full p-2 border border-gray-300 rounded-md text-sm mt-1" rows="2" placeholder="Please specify other experiment details"></textarea>
                            </div>
                        </div>
                    </div>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mt-4">
                        <div class="form-group">
                            <label for="quantity-${index}" class="block text-sm font-medium text-gray-700 mb-2">Required Quantity:</label>
                            <input type="number" id="quantity-${index}" name="quantity-${index}" min="1" value="1" required>
                        </div>
                        <div class="form-group">
                            <label for="desiredCompletionDate-${index}" class="block text-sm font-medium text-gray-700 mb-2">Desired Completion Date:</label>
                            <input type="date" id="desiredCompletionDate-${index}" name="desiredCompletionDate-${index}">
                        </div>
                    </div>
                    <div class="form-group mt-4">
                        <label for="sampleSpecialInstructions-${index}" class="block text-sm font-medium text-gray-700 mb-2">Sample Specific Instructions/Notes:</label>
                        <textarea id="sampleSpecialInstructions-${index}" name="sampleSpecialInstructions-${index}" rows="3" placeholder="Any specific requirements or details for this sample..."></textarea>
                    </div>
                </div>
            `;
        }

        // Function to add a new sample request block
        function addSampleRequest() {
            const container = document.getElementById('sampleRequestsContainer');
            const newBlockHtml = generateSampleBlockHtml(sampleCounter);
            container.insertAdjacentHTML('beforeend', newBlockHtml);
            addCompositionEntry(sampleCounter); // Add an initial composition entry for the new sample
            sampleCounter++;
        }

        // Function to remove a sample request block
        function removeSampleRequest(buttonElement) {
            const blockToRemove = buttonElement.closest('.sample-request-block');
            if (blockToRemove) {
                blockToRemove.remove();
                // Re-index remaining blocks to maintain sequential numbering
                const remainingBlocks = document.querySelectorAll('#sampleRequestsContainer .sample-request-block');
                remainingBlocks.forEach((block, index) => {
                    block.dataset.sampleIndex = index;
                    block.querySelector('.sample-index-display').textContent = index + 1;
                    // Update IDs and names of inputs within the re-indexed block
                    block.querySelectorAll('[id]').forEach(input => {
                        const oldId = input.id;
                        const newId = oldId.replace(/(-?\w+)-(\d+)$/, `$1-${index}`);
                        input.id = newId;
                        input.name = newId;
                    });
                });
                sampleCounter = remainingBlocks.length;
            }
        }

        // Function to handle dynamic dimension inputs based on sample shape for a specific block
        function handleShapeChangeForBlock(selectElement, index) {
            const block = selectElement.closest('.sample-request-block');
            const dimensionsContainer = block.querySelector(`#dimensionsContainer-${index}`);
            const selectedShape = selectElement.value;
            dimensionsContainer.innerHTML = '';

            let inputsHtml = '';
            switch (selectedShape) {
                case 'Cylinder':
                    inputsHtml = `
                        <label for="dimDiameter-${index}" class="block text-sm font-medium text-gray-700 mb-2">Diameter (mm):</label>
                        <input type="number" id="dimDiameter-${index}" name="dimDiameter-${index}" placeholder="e.g., 10" step="any" required>
                        <label for="dimLength-${index}" class="block text-sm font-medium text-gray-700 mb-2 mt-3">Length (mm):</label>
                        <input type="number" id="dimLength-${index}" name="dimLength-${index}" placeholder="e.g., 20" step="any" required>
                    `;
                    break;
                case 'Dogbone':
                    inputsHtml = `
                        <label for="dimGaugeLength-${index}" class="block text-sm font-medium text-gray-700 mb-2">Gauge Length (mm):</label>
                        <input type="number" id="dimGaugeLength-${index}" name="dimGaugeLength-${index}" placeholder="e.g., 15" step="any" required>
                        <label for="dimWidth-${index}" class="block text-sm font-medium text-gray-700 mb-2 mt-3">Width (mm):</label>
                        <input type="number" id="dimWidth-${index}" name="dimWidth-${index}" placeholder="e.g., 3" step="any" required>
                        <label for="dimThickness-${index}" class="block text-sm font-medium text-gray-700 mb-2 mt-3">Thickness (mm):</label>
                        <input type="number" id="dimThickness-${index}" name="dimThickness-${index}" placeholder="e.g., 1" step="any" required>
                    `;
                    break;
                case 'Disc':
                    inputsHtml = `
                        <label for="dimDiameter-${index}" class="block text-sm font-medium text-gray-700 mb-2">Diameter (mm):</label>
                        <input type="number" id="dimDiameter-${index}" name="dimDiameter-${index}" placeholder="e.g., 3" step="any" required>
                        <label for="dimThickness-${index}" class="block text-sm font-medium text-gray-700 mb-2 mt-3">Thickness (mm):</label>
                        <input type="number" id="dimThickness-${index}" name="dimThickness-${index}" placeholder="e.g., 0.5" step="any" required>
                    `;
                    break;
                case 'Cube':
                    inputsHtml = `
                        <label for="dimSideLength-${index}" class="block text-sm font-medium text-gray-700 mb-2">Side Length (mm):</label>
                        <input type="number" id="dimSideLength-${index}" name="dimSideLength-${index}" placeholder="e.g., 5" step="any" required>
                    `;
                    break;
                case 'Other':
                    inputsHtml = `
                        <label for="dimOther-${index}" class="block text-sm font-medium text-gray-700 mb-2">Specify Dimensions:</label>
                        <input type="text" id="dimOther-${index}" name="dimOther-${index}" placeholder="e.g., 15mm x 5mm x 2mm, irregular shape" required>
                    `;
                    break;
                default:
                    break;
            }
            dimensionsContainer.innerHTML = inputsHtml;
        }

        // Function to toggle experiment details textarea for a specific block
        function toggleExperimentDetailsForBlock(checkboxElement, index) {
            const detailsId = `details-${checkboxElement.value.replace(/[^a-zA-Z0-9]/g, '')}-${index}`;
            const textarea = document.getElementById(detailsId);
            if (textarea) {
                if (checkboxElement.checked) {
                    textarea.classList.remove('hidden');
                    textarea.setAttribute('required', 'true');
                } else {
                    textarea.classList.add('hidden');
                    textarea.removeAttribute('required');
                    textarea.value = '';
                }
            }
        }

        // Sample Composition Functions
        function addCompositionEntry(sampleIndex) {
            if (!compositionCounters[sampleIndex]) {
                compositionCounters[sampleIndex] = 0;
            }
            const entryIndex = compositionCounters[sampleIndex];
            const compositionContainer = document.getElementById(`compositionContainer-${sampleIndex}`);

            const newEntryDiv = document.createElement('div');
            newEntryDiv.classList.add('grid', 'grid-cols-1', 'md:grid-cols-4', 'gap-4', 'mb-3', 'items-end');
            newEntryDiv.dataset.compositionIndex = entryIndex;

            newEntryDiv.innerHTML = `
                <div class="form-group">
                    <label for="element-${sampleIndex}-${entryIndex}" class="block text-sm font-medium text-gray-700 mb-1">Element:</label>
                    <select id="element-${sampleIndex}-${entryIndex}" name="element-${sampleIndex}-${entryIndex}" class="element-select" onchange="populateIsotopesForBlock(this, document.getElementById('isotope-${sampleIndex}-${entryIndex}'), ${sampleIndex}, ${entryIndex})" required>
                        <option value="">Select Element</option>
                        ${periodicElements.map(el => `<option value="${el.symbol}">${el.name} (${el.symbol})</option>`).join('')}
                    </select>
                </div>
                <div class="form-group">
                    <label for="isotope-${sampleIndex}-${entryIndex}" class="block text-sm font-medium text-gray-700 mb-1">Isotope:</label>
                    <select id="isotope-${sampleIndex}-${entryIndex}" name="isotope-${sampleIndex}-${entryIndex}" required>
                        <option value="Natural Concentration" selected>Natural Concentration</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="percentage-${sampleIndex}-${entryIndex}" class="block text-sm font-medium text-gray-700 mb-1">Percentage (%):</label>
                    <input type="number" id="percentage-${sampleIndex}-${entryIndex}" name="percentage-${sampleIndex}-${entryIndex}" placeholder="e.g., 99.9" step="0.001" min="0" max="100" required>
                </div>
                <div class="form-group">
                    <button type="button" onclick="removeCompositionEntry(this, ${sampleIndex})" class="bg-red-500 hover:bg-red-600 text-white px-4 py-2 rounded-md text-sm w-full">Remove</button>
                </div>
            `;
            compositionContainer.appendChild(newEntryDiv);
            compositionCounters[sampleIndex]++;
        }

        function removeCompositionEntry(buttonElement, sampleIndex) {
            const entryToRemove = buttonElement.closest('div[data-composition-index]');
            if (entryToRemove) {
                entryToRemove.remove();
                const compositionContainer = document.getElementById(`compositionContainer-${sampleIndex}`);
                const remainingEntries = compositionContainer.querySelectorAll('div[data-composition-index]');
                remainingEntries.forEach((entry, idx) => {
                    entry.dataset.compositionIndex = idx;
                    entry.querySelectorAll('[id]').forEach(input => {
                        const oldId = input.id;
                        const parts = oldId.split('-');
                        parts[parts.length - 1] = idx;
                        input.id = parts.join('-');
                        input.name = parts.join('-');
                    });
                });
                compositionCounters[sampleIndex] = remainingEntries.length;
            }
        }

        function populateIsotopesForBlock(elementSelect, isotopeSelect, sampleIndex, entryIndex) {
            const selectedSymbol = elementSelect.value;
            isotopeSelect.innerHTML = '<option value="Natural Concentration" selected>Natural Concentration</option>';

            if (selectedSymbol && isotopeMap[selectedSymbol]) {
                isotopeMap[selectedSymbol].forEach(isotope => {
                    const option = document.createElement('option');
                    option.value = isotope;
                    option.textContent = isotope;
                    isotopeSelect.appendChild(option);
                });
            }
        }

        // Handle form submission for all samples
        document.getElementById('sampleRequestForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const formData = new FormData(this);
            const lotNumber = formData.get('lotNumber');
            const collaboratorEmail = formData.get('collaboratorEmail');

            const requestData = {
                type: 'sampleRequest',
                collaboratorName: formData.get('collaboratorName'),
                collaboratorCompany: formData.get('collaboratorCompany'),
                collaboratorEmail: collaboratorEmail,
                collaboratorPhone: formData.get('collaboratorPhone'),
                generalSpecialInstructions: formData.get('generalSpecialInstructions'),
                lotNumber: lotNumber,
                samples: []
            };

            // Iterate over each sample request block
            document.querySelectorAll('#sampleRequestsContainer .sample-request-block').forEach((block, sampleIndex) => {
                const sample = {};
                sample.sampleID = block.querySelector(`#sampleID-${sampleIndex}`).value;
                sample.materialType = block.querySelector(`#materialType-${sampleIndex}`).value;
                sample.sampleShape = block.querySelector(`#sampleShape-${sampleIndex}`).value;
                sample.weight = block.querySelector(`#weight-${sampleIndex}`).value;

                // Collect dynamic dimensions
                sample.dimensions = {};
                block.querySelectorAll(`#dimensionsContainer-${sampleIndex} input`).forEach(input => {
                    sample.dimensions[input.name] = input.value;
                });

                // Collect experiment types and their details
                sample.experimentTypes = [];
                block.querySelectorAll(`input[name^="experimentType-${sampleIndex}"]:checked`).forEach(checkbox => {
                    const type = checkbox.value;
                    const detailsTextarea = block.querySelector(`#details-${type.replace(/[^a-zA-Z0-9]/g, '')}-${sampleIndex}`);
                    const details = detailsTextarea ? detailsTextarea.value.trim() : '';
                    sample.experimentTypes.push({ type, details });
                });

                // Collect sample composition
                sample.composition = [];
                block.querySelectorAll(`#compositionContainer-${sampleIndex} > div[data-composition-index]`).forEach((entryDiv, entryIndex) => {
                    const element = entryDiv.querySelector(`#element-${sampleIndex}-${entryIndex}`).value;
                    const isotope = entryDiv.querySelector(`#isotope-${sampleIndex}-${entryIndex}`).value;
                    const percentage = entryDiv.querySelector(`#percentage-${sampleIndex}-${entryIndex}`).value;
                    if (element && percentage) {
                        sample.composition.push({ element, isotope, percentage: parseFloat(percentage) });
                    }
                });

                sample.quantity = block.querySelector(`#quantity-${sampleIndex}`).value;
                sample.desiredCompletionDate = block.querySelector(`#desiredCompletionDate-${sampleIndex}`).value;
                sample.sampleSpecialInstructions = block.querySelector(`#sampleSpecialInstructions-${sampleIndex}`).value;

                requestData.samples.push(sample);
            });

            const result = await sendDataToGoogleAppsScript(requestData);

            if (result.success) {
                alert('All sample requests submitted! Check your email and the Google Sheet for updates.');
                this.reset();
                document.getElementById('sampleRequestsContainer').innerHTML = '';
                sampleCounter = 0;
                compositionCounters = {};
                addSampleRequest();
                renderTrackSamplesTable();
                renderViewDataTable();
            } else {
                alert('Error submitting request: ' + result.message);
            }
        });

        // Dummy data for initial load and demonstration
        const dummySamples = [
            { lotNumber: "LOT-2025-001", collaboratorEmail: "user1@example.com", samples: [
                { sampleID: "MIT-SAMPLE-001", materialType: "Alloy 625", experimentType: "High Temperature", status: "Pending", approvalDate: "N/A", shippingInstructions: "Awaiting approval...", trackingNumber: "", dataUploadDate: "N/A", dataAvailable: "No data uploaded yet." },
                { sampleID: "MIT-SAMPLE-002", materialType: "Zirconium Alloy", experimentType: "Irradiation", status: "Approved", approvalDate: "2025-05-20", shippingInstructions: "Ship to: MIT Lab 123, Attn: Dr. Smith. Use FedEx Priority Overnight. Include sample manifest.", trackingNumber: "FEDEX12345", dataUploadDate: "2025-06-01", dataAvailable: "Initial dose data, basic microscopy images." }
            ]},
            { lotNumber: "LOT-2025-002", collaboratorEmail: "user2@example.com", samples: [
                { sampleID: "MIT-SAMPLE-003", materialType: "SS 316L", experimentType: "Mechanical Characterization", status: "Shipped", approvalDate: "2025-05-22", shippingInstructions: "Ship to: MIT Lab 456, Attn: Dr. Jones. Use DHL Express. Pack securely.", trackingNumber: "DHL987654321", dataUploadDate: "2025-06-05", dataAvailable: "Tensile strength curves, ductility values, hardness maps." },
                { sampleID: "MIT-SAMPLE-004", materialType: "Copper", experimentType: "Microstructural Characterization", status: "Data Ready", approvalDate: "2025-05-15", shippingInstructions: "Sample received and processed.", trackingNumber: "UPS987654321", dataUploadDate: "2025-06-10", dataAvailable: "SEM images, EBSD maps, grain size analysis." }
            ]}
        ];

        allSamplesData = dummySamples;

        // Function to render the "Track Samples" table
        function renderTrackSamplesTable() {
            const tbody = document.getElementById('sampleTrackingTableBody');
            tbody.innerHTML = '';

            allSamplesData.forEach(lot => {
                const lotHeaderRow = document.createElement('tr');
                lotHeaderRow.innerHTML = `<td colspan="7" class="lot-header">Lot Number: ${lot.lotNumber}</td>`;
                tbody.appendChild(lotHeaderRow);

                const trackingButtonRow = document.createElement('tr');
                trackingButtonRow.innerHTML = `
                    <td colspan="7" class="py-2 px-4 bg-gray-50">
                        <div class="flex justify-start">
                            <button type="button" onclick="openTrackingInput('${lot.lotNumber}')" class="mit-blue-bg hover:opacity-90 text-white px-4 py-2 rounded-md text-sm">Add Tracking Details for Lot ${lot.lotNumber}</button>
                        </div>
                    </td>
                `;
                tbody.appendChild(trackingButtonRow);

                lot.samples.forEach(sample => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200';
                    row.innerHTML = `
                        <td class="py-3 px-4">${sample.sampleID}</td>
                        <td class="py-3 px-4">${sample.materialType}</td>
                        <td class="py-3 px-4">${Array.isArray(sample.experimentType) ? sample.experimentType.map(e => e.type || e).join(', ') : sample.experimentType || 'N/A'}</td>
                        <td class="py-3 px-4 text-${getStatusColor(sample.status)}-600 font-semibold">${sample.status}</td>
                        <td class="py-3 px-4">${sample.approvalDate || 'N/A'}</td>
                        <td class="py-3 px-4">
                            <textarea class="w-full p-2 border border-gray-300 rounded-md text-sm" rows="2" readonly>${sample.shippingInstructions}</textarea>
                        </td>
                        <td class="py-3 px-4" id="trackingCell-${sample.sampleID}">
                            ${sample.trackingNumber ? `<input type="text" class="w-full p-2 border border-gray-300 rounded-md text-sm" value="${sample.trackingNumber}" readonly>` : 'N/A'}
                        </td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        // Function to render the "View Sample Data" table
        function renderViewDataTable() {
            const tbody = document.getElementById('sampleDataTableBody');
            tbody.innerHTML = '';

            allSamplesData.forEach(lot => {
                const lotHeaderRow = document.createElement('tr');
                lotHeaderRow.innerHTML = `
                    <td colspan="5" class="lot-header flex justify-between items-center">
                        <span>Lot Number: ${lot.lotNumber}</span>
                        <button type="button" onclick="openLotDataRequestInlineForm('${lot.lotNumber}')" class="mit-blue-bg hover:opacity-90 text-white px-4 py-2 rounded-md text-sm">Request Data for Lot</button>
                    </td>
                `;
                tbody.appendChild(lotHeaderRow);

                lot.samples.forEach(sample => {
                    const row = document.createElement('tr');
                    row.className = 'border-b border-gray-200';
                    row.innerHTML = `
                        <td class="py-3 px-4 sample-id-cell">${sample.sampleID}</td>
                        <td class="py-3 px-4">${Array.isArray(sample.experimentType) ? sample.experimentType.map(e => e.type || e).join(', ') : sample.experimentType || 'N/A'}</td>
                        <td class="py-3 px-4">${sample.dataUploadDate || 'N/A'}</td>
                        <td class="py-3 px-4">
                            <button class="mit-blue-bg hover:opacity-90 text-white px-4 py-2 rounded-md text-sm" onclick="openDataRequestInlineForm(this, '${sample.sampleID}')">Request Data</button>
                        </td>
                        <td class="py-3 px-4">${sample.dataAvailable || 'N/A'}</td>
                    `;
                    tbody.appendChild(row);
                });
            });
        }

        // Helper function to get status color class
        function getStatusColor(status) {
            switch (status) {
                case 'Pending': return 'orange';
                case 'Approved': return 'green';
                case 'Shipped': return 'blue';
                case 'Data Ready': return 'purple';
                default: return 'gray';
            }
        }

        // Placeholder functions for data request and tracking
        function openDataRequestInlineForm(buttonElement, sampleId) {
            alert(`Data request form for ${sampleId} would open here`);
        }

        function openLotDataRequestInlineForm(lotNumber) {
            alert(`Lot data request form for ${lotNumber} would open here`);
        }

        function openTrackingInput(lotNumber) {
            alert(`Tracking input for ${lotNumber} would open here`);
        }

        function refreshTrackSamples() {
            console.log("Refreshing sample tracking data...");
            alert("Sample tracking data refreshed!");
            renderTrackSamplesTable();
        }

        // Tab functionality
        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.add("hidden");
                tabcontent[i].classList.remove("active");
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.remove("hidden");
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // Initialize the application
        console.log('Application initialized, waiting for login...');
    </script>
</body>
</html>
