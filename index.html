<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MIT- Nuclear Innovations Fission Technology Sample Management System</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for Inter font and general body */
        body {
            font-family: 'Inter', sans-serif;
            @apply bg-gray-100 text-gray-800;
        }
        /* MIT Blue for headings and active elements */
        .mit-blue {
            color: #005A9C; /* MIT Blue */
        }
        .mit-blue-bg {
            background-color: #005A9C; /* MIT Blue */
        }
        .mit-light-blue-bg {
            background-color: #ADD8E6; /* Light Blue, can be used for secondary elements */
        }
        .mit-orange {
            color: #E66C00; /* MIT Orange, for accents or warnings */
        }
        .mit-red {
            color: #A31F34; /* MIT Red, for errors or destructive actions */
        }
        .mit-green {
            color: #6C9F3E; /* MIT Green, for success */
        }

        /* General input styling */
        input[type="text"],
        input[type="email"],
        input[type="number"],
        input[type="date"],
        select,
        textarea {
            @apply w-full p-3 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-mit-blue;
        }
        /* Button styling */
        button {
            @apply px-6 py-3 rounded-md font-semibold transition duration-300 ease-in-out;
        }
        .tab-button.active {
            @apply mit-blue-bg text-white;
        }
        .tab-button:not(.active) {
            @apply bg-gray-200 text-gray-700 hover:bg-gray-300;
        }

        /* Inline form specific styles for data request */
        .inline-data-request-form-container {
            @apply bg-gray-50 p-6 border-t border-b border-gray-200;
        }
        .inline-data-request-form-container .form-group {
            margin-bottom: 1rem; /* Adjust spacing for inline form */
        }

        /* Styles for dynamic sample request blocks */
        .sample-request-block {
            @apply border border-gray-200 p-6 rounded-lg shadow-sm bg-white mb-6 relative;
        }
        .sample-request-block .remove-button {
            @apply absolute top-4 right-4 text-red-500 hover:text-red-700 font-bold text-sm;
        }

        /* Composition table styling */
        .composition-table {
            @apply w-full border-collapse;
        }
        .composition-table th, .composition-table td {
            @apply p-2 border border-gray-200 text-sm;
        }
        .composition-table th {
            @apply bg-gray-50 text-left font-medium text-gray-700;
        }

        /* Login page specific styles */
        .login-container {
            @apply flex items-center justify-center min-h-screen bg-gray-100;
        }
        .login-card {
            @apply bg-white p-8 rounded-lg shadow-lg w-full max-w-md;
        }
        .error-message {
            @apply text-red-600 text-center mb-4;
        }
        /* Style for lot number header in tables */
        .lot-header {
            @apply bg-blue-100 text-blue-800 font-bold text-lg py-3 px-4 border-b border-blue-200;
        }
        .tracking-input-row-dynamic, .lot-data-request-row-dynamic { /* Updated class name */
            @apply bg-gray-50;
        }

        /* Message Box Styling */
        #messageBox {
            @apply fixed bottom-4 right-4 bg-blue-600 text-white p-4 rounded-lg shadow-lg z-50 hidden;
        }
        #messageBox.success {
            @apply bg-green-600;
        }
        #messageBox.error {
            @apply bg-red-600;
        }
    </style>
</head>
<body>
    <div id="messageBox" class="hidden"></div>

    <div id="loginPage" class="login-container">
        <div class="login-card">
            <h2 class="text-2xl font-bold text-center mb-6 mit-blue">Login to MIT Nuclear Innovations Fission Technology Sample Management</h2>
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group mb-4">
                    <label for="username" class="block text-sm font-medium text-gray-700 mb-2">Username:</label>
                    <input type="text" id="username" name="username" placeholder="admin" required>
                </div>
                <div class="form-group mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-700 mb-2">Password:</label>
                    <input type="password" id="password" name="password" placeholder="password123" required>
                </div>
                <p id="loginError" class="error-message hidden">Invalid username or password.</p>
                <button type="submit" class="mit-blue-bg text-white w-full py-3 rounded-md hover:opacity-90 transition duration-300">Login</button>
            </form>
        </div>
    </div>

    <div id="mainContent" class="container mx-auto p-6 md:p-10 bg-white shadow-lg rounded-lg my-8 max-w-4xl hidden">
        <h1 class="text-3xl md:text-4xl font-bold text-center mb-6 mit-blue">MIT- Nuclear Innovations Fission Technology Sample Management System</h1>

        <div class="flex flex-wrap justify-center mb-8 border-b-2 border-gray-200">
            <button class="tab-button py-3 px-6 rounded-t-lg text-lg font-medium transition-colors duration-300 active" onclick="openTab(event, 'requestSample')">Request Sample</button>
            <button class="tab-button py-3 px-6 rounded-t-lg text-lg font-medium transition-colors duration-300" onclick="openTab(event, 'trackSamples')">Track Samples</button>
            <button class="tab-button py-3 px-6 rounded-t-lg text-lg font-medium transition-colors duration-300" onclick="openTab(event, 'viewData')">View Sample Data</button>
        </div>

        <div id="requestSample" class="tab-content active">
            <h2 class="text-2xl font-semibold mb-6 mit-blue">Submit a New Sample Request</h2>
            <p class="text-gray-600 mb-6">Fill out the form below to submit new sample requests. Remember to specify details for each sample and provide a unique Lot Number for the batch. Click "Add Another Sample" to include multiple samples under the same lot.</p>
            <form id="sampleRequestForm">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 p-6 bg-blue-50 rounded-lg border border-blue-200">
                    <h3 class="text-xl font-semibold col-span-full mit-blue mb-4">Collaborator Information</h3>
                    <div class="form-group">
                        <label for="collaboratorName" class="block text-sm font-medium text-gray-700 mb-2">Name:</label>
                        <input type="text" id="collaboratorName" name="collaboratorName" placeholder="John Doe" required>
                    </div>
                    <div class="form-group">
                        <label for="collaboratorCompany" class="block text-sm font-medium text-gray-700 mb-2">Company:</label>
                        <input type="text" id="collaboratorCompany" name="collaboratorCompany" placeholder="e.g., MIT, Acme Materials Inc." required>
                    </div>
                    <div class="form-group">
                        <label for="collaboratorEmail" class="block text-sm font-medium text-gray-700 mb-2">Email:</label>
                        <input type="email" id="collaboratorEmail" name="collaboratorEmail" placeholder="johndoe@example.com" required>
                    </div>
                    <div class="form-group">
                        <label for="collaboratorPhone" class="block text-sm font-medium text-gray-700 mb-2">Phone (Optional):</label>
                        <input type="text" id="collaboratorPhone" name="collaboratorPhone" placeholder="e.g., +1-123-456-7890">
                    </div>
                </div>

                <div class="form-group mb-6 p-6 bg-yellow-50 rounded-lg border border-yellow-200">
                    <label for="lotNumber" class="block text-sm font-medium text-gray-700 mb-2">Lot Number (for this batch of samples):</label>
                    <input type="text" id="lotNumber" name="lotNumber" placeholder="e.g., LOT-2025-001" required>
                </div>

                <div id="sampleRequestsContainer">
                    </div>

                <div class="flex justify-center mt-6 mb-8">
                    <button type="button" onclick="addSampleRequest()" class="bg-green-600 hover:bg-green-700 text-white py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out">
                        Add Another Sample
                    </button>
                </div>

                <div class="form-group col-span-1 md:col-span-2">
                    <label for="generalSpecialInstructions" class="block text-sm font-medium text-gray-700 mb-2">General Special Instructions for All Samples:</label>
                    <textarea id="generalSpecialInstructions" name="generalSpecialInstructions" rows="4" placeholder="Any overall requirements or details not covered above for all samples..."></textarea>
                </div>

                <div class="form-group col-span-1 md:col-span-2 text-center mt-8">
                    <button type="submit" class="mit-blue-bg hover:opacity-90 text-white py-3 px-8 rounded-lg shadow-md transition duration-300 ease-in-out">Submit All Requests</button>
                </div>
            </form>
        </div>

        <div id="trackSamples" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 mit-blue">Track Your Sample Requests</h2>
            <p class="text-gray-600 mb-6">Monitor the status of your submitted samples here, grouped by Lot Number. Once approved, you'll find shipping instructions. Use the 'Add Tracking Details' button for each lot to enter tracking numbers when available. You will receive an approval email with further instructions.</p>
            <div class="flex justify-end mb-4">
                <button type="button" onclick="refreshTrackSamples()" class="mit-blue-bg hover:opacity-90 text-white py-2 px-5 rounded-md flex items-center">
                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004 10.59V10m5-3.54l-3 3m0 0l3 3m-3-3H2m14 2.5v4h.582m-15.356-2A8.001 8.001 0 0120 13.41V14m-5 3.54l3-3m0 0l-3-3m3 3H22"></path></svg>
                    Refresh
                </button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-md">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-md">Sample ID</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Material</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Experiment Type</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Status</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Approval Date</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Shipping Instructions</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-md">Tracking Number</th>
                        </tr>
                    </thead>
                    <tbody id="sampleTrackingTableBody">
                        </tbody>
                </table>
            </div>
        </div>

        <div id="viewData" class="tab-content hidden">
            <h2 class="text-2xl font-semibold mb-6 mit-blue">View Sample Data</h2>
            <p class="text-gray-600 mb-6">Access data for your completed samples here, grouped by Lot Number. You can request data for individual samples or for an entire lot. Note that requesting data for an entire lot might take longer; consider requesting specific samples for a faster response. You will receive an email if new updates are made to the sample.</p>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-md">
                    <thead>
                        <tr class="bg-gray-100">
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tl-md">Sample ID</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Experiment Type</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Last Updated Date</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider">Request Data</th>
                            <th class="py-3 px-4 text-left text-sm font-medium text-gray-600 uppercase tracking-wider rounded-tr-md">Data Available</th>
                        </tr>
                    </thead>
                    <tbody id="sampleDataTableBody">
                        </tbody>
                </table>
            </div>
        </div>
    </div>

    <script>
        let sampleCounter = 0; // Global counter for unique sample block IDs
        // Removed allSamplesData as data will now be fetched from GS
        // const ADMIN_EMAIL = 'arunmdm@mit.edu'; // Admin email is now handled in GS

        // IMPORTANT: Replace this with your deployed Google Apps Script Web App URL
        const WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbzoituBOzpu7o7jS8RyiREHAxFbRyKOGrBhx_tNH-bj_GBBAY5Q6EX5AOK7_oeE6KOc/exec';

        // Data for periodic table elements and their isotopes (kept as is)
        const periodicElements = [
            { symbol: "H", name: "Hydrogen", isotopes: ["1H", "2H", "3H"] },
            { symbol: "He", name: "Helium", isotopes: ["3He", "4He"] },
            { symbol: "Li", name: "Lithium", isotopes: ["6Li", "7Li"] },
            { symbol: "Be", name: "Beryllium", isotopes: ["9Be"] },
            { symbol: "B", name: "Boron", isotopes: ["10B", "11B"] },
            { symbol: "C", name: "Carbon", isotopes: ["12C", "13C", "14C"] },
            { symbol: "N", name: "Nitrogen", isotopes: ["14N", "15N"] },
            { symbol: "O", name: "Oxygen", isotopes: ["16O", "17O", "18O"] },
            { symbol: "F", name: "Fluorine", isotopes: ["19F"] },
            { symbol: "Ne", name: "Neon", isotopes: ["20Ne", "21Ne", "22Ne"] },
            { symbol: "Na", name: "Sodium", isotopes: ["23Na"] },
            { symbol: "Mg", name: "Magnesium", isotopes: ["24Mg", "25Mg", "26Mg"] },
            { symbol: "Al", name: "Aluminum", isotopes: ["27Al"] },
            { symbol: "Si", name: "Silicon", isotopes: ["28Si", "29Si", "30Si"] },
            { symbol: "P", name: "Phosphorus", isotopes: ["31P"] },
            { symbol: "S", name: "Sulfur", isotopes: ["32S", "33S", "34S", "36S"] },
            { symbol: "Cl", name: "Chlorine", isotopes: ["35Cl", "37Cl"] },
            { symbol: "Ar", name: "Argon", isotopes: ["36Ar", "38Ar", "40Ar"] },
            { symbol: "K", name: "Potassium", isotopes: ["39K", "40K", "41K"] },
            { symbol: "Ca", name: "Calcium", isotopes: ["40Ca", "42Ca", "43Ca", "44Ca", "46Ca", "48Ca"] },
            { symbol: "Sc", name: "Scandium", isotopes: ["45Sc"] },
            { symbol: "Ti", name: "Titanium", isotopes: ["46Ti", "47Ti", "48Ti", "49Ti", "50Ti"] },
            { symbol: "V", name: "Vanadium", isotopes: ["50V", "51V"] },
            { symbol: "Cr", name: "Chromium", isotopes: ["50Cr", "52Cr", "53Cr", "54Cr"] },
            { symbol: "Mn", name: "Manganese", isotopes: ["55Mn"] },
            { symbol: "Fe", name: "Iron", isotopes: ["54Fe", "56Fe", "57Fe", "58Fe"] },
            { symbol: "Co", name: "Cobalt", isotopes: ["59Co"] },
            { symbol: "Ni", name: "Nickel", isotopes: ["58Ni", "60Ni", "61Ni", "62Ni", "64Ni"] },
            { symbol: "Cu", name: "Copper", isotopes: ["63Cu", "65Cu"] },
            { symbol: "Zn", name: "Zinc", isotopes: ["64Zn", "66Zn", "67Zn", "68Zn", "70Zn"] },
            { symbol: "Ga", name: "Gallium", isotopes: ["69Ga", "71Ga"] },
            { symbol: "Ge", name: "Germanium", isotopes: ["70Ge", "72Ge", "73Ge", "74Ge", "76Ge"] },
            { symbol: "As", name: "Arsenic", isotopes: ["75As"] },
            { symbol: "Se", name: "Selenium", isotopes: ["74Se", "76Se", "77Se", "78Se", "80Se", "82Se"] },
            { symbol: "Br", name: "Bromine", isotopes: ["79Br", "81Br"] },
            { symbol: "Kr", name: "Krypton", isotopes: ["78Kr", "80Kr", "82Kr", "83Kr", "84Kr", "86Kr"] },
            { symbol: "Rb", name: "Rubidium", isotopes: ["85Rb", "87Rb"] },
            { symbol: "Sr", name: "Strontium", isotopes: ["84Sr", "86Sr", "87Sr", "88Sr"] },
            { symbol: "Y", name: "Yttrium", isotopes: ["89Y"] },
            { symbol: "Zr", name: "Zirconium", isotopes: ["90Zr", "91Zr", "92Zr", "94Zr", "96Zr"] },
            { symbol: "Nb", name: "Niobium", isotopes: ["93Nb"] },
            { symbol: "Mo", name: "Molybdenum", isotopes: ["92Mo", "94Mo", "95Mo", "96Mo", "97Mo", "98Mo", "100Mo"] },
            { symbol: "Tc", name: "Technetium", isotopes: ["98Tc"] }, // Most stable isotope
            { symbol: "Ru", name: "Ruthenium", isotopes: ["96Ru", "98Ru", "99Ru", "100Ru", "101Ru", "102Ru", "104Ru"] },
            { symbol: "Rh", name: "Rhodium", isotopes: ["103Rh"] },
            { symbol: "Pd", name: "Palladium", isotopes: ["102Pd", "104Pd", "105Pd", "106Pd", "108Pd", "110Pd"] },
            { symbol: "Ag", name: "Silver", isotopes: ["107Ag", "109Ag"] },
            { symbol: "Cd", name: "Cadmium", isotopes: ["106Cd", "108Cd", "110Cd", "111Cd", "112Cd", "113Cd", "114Cd", "116Cd"] },
            { symbol: "In", name: "Indium", isotopes: ["113In", "115In"] },
            { symbol: "Sn", name: "Tin", isotopes: ["112Sn", "114Sn", "115Sn", "116Sn", "117Sn", "118Sn", "119Sn", "120Sn", "122Sn", "124Sn"] },
            { symbol: "Sb", name: "Antimony", isotopes: ["121Sb", "123Sb"] },
            { symbol: "Te", name: "Tellurium", isotopes: ["120Te", "122Te", "123Te", "124Te", "125Te", "126Te", "128Te", "130Te"] },
            { symbol: "I", name: "Iodine", isotopes: ["127I"] },
            { symbol: "Xe", name: "Xenon", isotopes: ["124Xe", "126Xe", "128Xe", "129Xe", "130Xe", "131Xe", "132Xe", "134Xe", "136Xe"] },
            { symbol: "Cs", name: "Cesium", isotopes: ["133Cs"] },
            { symbol: "Ba", name: "Barium", isotopes: ["130Ba", "132Ba", "134Ba", "135Ba", "136Ba", "137Ba", "138Ba"] },
            { symbol: "La", name: "Lanthanum", isotopes: ["138La", "139La"] },
            { symbol: "Ce", name: "Cerium", isotopes: ["136Ce", "138Ce", "140Ce", "142Ce"] },
            { symbol: "Pr", name: "Praseodymium", isotopes: ["141Pr"] },
            { symbol: "Nd", name: "Neodymium", isotopes: ["142Nd", "143Nd", "144Nd", "145Nd", "146Nd", "148Nd", "150Nd"] },
            { symbol: "Pm", name: "Promethium", isotopes: ["145Pm", "147Pm"] },
            { symbol: "Sm", name: "Samarium", isotopes: ["144Sm", "147Sm", "148Sm", "149Sm", "150Sm", "152Sm", "154Sm"] },
            { symbol: "Eu", name: "Europium", isotopes: ["151Eu", "153Eu"] },
            { symbol: "Gd", name: "Gadolinium", isotopes: ["152Gd", "154Gd", "155Gd", "156Gd", "157Gd", "158Gd", "160Gd"] },
            { symbol: "Tb", name: "Terbium", isotopes: ["159Tb"] },
            { symbol: "Dy", name: "Dysprosium", isotopes: ["156Dy", "158Dy", "160Dy", "161Dy", "162Dy", "163Dy", "164Dy"] },
            { symbol: "Ho", name: "Holmium", isotopes: ["165Ho"] },
            { symbol: "Er", name: "Erbium", isotopes: ["162Er", "164Er", "166Er", "167Er", "168Er", "170Er"] },
            { symbol: "Tm", name: "Thulium", isotopes: ["169Tm"] },
            { symbol: "Yb", name: "Ytterbium", isotopes: ["168Yb", "170Yb", "171Yb", "172Yb", "173Yb", "174Yb", "176Yb"] },
            { symbol: "Lu", name: "Lutetium", isotopes: ["175Lu", "176Lu"] },
            { symbol: "Hf", name: "Hafnium", isotopes: ["174Hf", "176Hf", "177Hf", "178Hf", "179Hf", "180Hf"] },
            { symbol: "Ta", name: "Tantalum", isotopes: ["180mTa", "181Ta"] },
            { symbol: "W", name: "Tungsten", isotopes: ["180W", "182W", "183W", "184W", "186W"] },
            { symbol: "Re", name: "Rhenium", isotopes: ["185Re", "187Re"] },
            { symbol: "Os", name: "Osmium", isotopes: ["184Os", "186Os", "187Os", "188Os", "189Os", "190Os", "192Os"] },
            { symbol: "Ir", name: "Iridium", isotopes: ["191Ir", "193Ir"] },
            { symbol: "Pt", name: "Platinum", isotopes: ["190Pt", "192Pt", "194Pt", "195Pt", "196Pt", "198Pt"] },
            { symbol: "Au", name: "Gold", isotopes: ["197Au"] },
            { symbol: "Hg", name: "Mercury", isotopes: ["196Hg", "198Hg", "199Hg", "200Hg", "201Hg", "202Hg", "204Hg"] },
            { symbol: "Tl", name: "Thallium", isotopes: ["203Tl", "205Tl"] },
            { symbol: "Pb", name: "Lead", isotopes: ["204Pb", "206Pb", "207Pb", "208Pb"] },
            { symbol: "Bi", name: "Bismuth", isotopes: ["209Bi"] },
            { symbol: "Po", name: "Polonium", isotopes: ["209Po", "210Po"] }, // Most stable isotopes
            { symbol: "At", name: "Astatine", isotopes: ["210At"] },
            { symbol: "Rn", name: "Radon", isotopes: ["222Rn"] },
            { symbol: "Fr", name: "Francium", isotopes: ["223Fr"] },
            { symbol: "Ra", name: "Radium", isotopes: ["226Ra"] },
            { symbol: "Ac", name: "Actinium", isotopes: ["227Ac"] },
            { symbol: "Th", name: "Thorium", isotopes: ["230Th", "232Th"] },
            { symbol: "Pa", name: "Protactinium", isotopes: ["231Pa"] },
            { symbol: "U", name: "Uranium", isotopes: ["233U", "234U", "235U", "238U"] },
            { symbol: "Np", name: "Neptunium", isotopes: ["237Np"] },
            { symbol: "Pu", name: "Plutonium", isotopes: ["238Pu", "239Pu", "240Pu", "241Pu", "242Pu", "244Pu"] },
            { symbol: "Am", name: "Americium", isotopes: ["241Am", "243Am"] },
            { symbol: "Cm", name: "Curium", isotopes: ["242Cm", "244Cm", "245Cm", "246Cm", "247Cm", "248Cm"] },
            { symbol: "Bk", name: "Berkelium", isotopes: ["247Bk"] },
            { symbol: "Cf", name: "Californium", isotopes: ["249Cf", "250Cf", "251Cf", "252Cf"] },
            { symbol: "Es", name: "Einsteinium", isotopes: ["252Es"] },
            { symbol: "Fm", name: "Fermium", isotopes: ["257Fm"] },
            { symbol: "Md", name: "Mendelevium", isotopes: ["258Md"] },
            { symbol: "No", name: "Nobelium", isotopes: ["259No"] },
            { symbol: "Lr", name: "Lawrencium", isotopes: ["262Lr"] },
            { symbol: "Rf", name: "Rutherfordium", isotopes: ["261Rf"] },
            { symbol: "Db", name: "Dubnium", isotopes: ["262Db"] },
            { symbol: "Sg", name: "Seaborgium", isotopes: ["266Sg"] },
            { symbol: "Bh", name: "Bohrium", isotopes: ["264Bh"] },
            { symbol: "Hs", name: "Hassium", isotopes: ["269Hs"] },
            { symbol: "Mt", name: "Meitnerium", isotopes: ["276Mt"] },
            { symbol: "Ds", name: "Darmstadtium", isotopes: ["281Ds"] },
            { symbol: "Rg", name: "Roentgenium", isotopes: ["280Rg"] },
            { symbol: "Cn", name: "Copernicium", isotopes: ["285Cn"] },
            { symbol: "Nh", name: "Nihonium", isotopes: ["286Nh"] },
            { symbol: "Fl", name: "Flerovium", isotopes: ["289Fl"] },
            { symbol: "Mc", name: "Moscovium", isotopes: ["290Mc"] },
            { symbol: "Lv", name: "Livermorium", isotopes: ["293Lv"] },
            { symbol: "Ts", name: "Tennessine", isotopes: ["294Ts"] },
            { symbol: "Og", name: "Oganesson", isotopes: ["294Og"] }
        ];

        // Function to display messages to the user
        function showMessage(message, type = 'info') {
            const messageBox = document.getElementById('messageBox');
            messageBox.textContent = message;
            messageBox.className = 'fixed bottom-4 right-4 p-4 rounded-lg shadow-lg z-50'; // Reset classes
            messageBox.classList.add(type); // Add type class (success, error, info)
            messageBox.classList.remove('hidden');
            setTimeout(() => {
                messageBox.classList.add('hidden');
            }, 5000); // Hide after 5 seconds
        }

        // Login handler (kept as is, but now calls GS init)
        function handleLogin(event) {
            event.preventDefault();
            const username = document.getElementById('username').value;
            const password = document.getElementById('password').value;
            const loginError = document.getElementById('loginError');

            if (username === 'admin' && password === 'password123') {
                document.getElementById('loginPage').classList.add('hidden');
                document.getElementById('mainContent').classList.remove('hidden');
                loginError.classList.add('hidden');
                
                // Initialize Google Sheet on successful login
                google.script.run
                    .withSuccessHandler(function(response) {
                        console.log(response);
                        showMessage(response, 'success');
                        addSampleRequest(); // Initialize with one sample request block
                        renderTrackSamplesTable(); // Render tables after login
                        renderViewDataTable();
                    })
                    .withFailureHandler(function(error) {
                        console.error("Error initializing Google Sheet:", error.message);
                        showMessage("Failed to initialize system: " + error.message, 'error');
                    })
                    .initializeGoogleSheet();
            } else {
                loginError.classList.remove('hidden');
            }
        }

        // JavaScript for tab functionality (kept as is)
        function openTab(evt, tabName) {
            var i, tabcontent, tabbuttons;
            tabcontent = document.getElementsByClassName("tab-content");
            for (i = 0; i < tabcontent.length; i++) {
                tabcontent[i].classList.add("hidden");
                tabcontent[i].classList.remove("active");
            }
            tabbuttons = document.getElementsByClassName("tab-button");
            for (i = 0; i < tabbuttons.length; i++) {
                tabbuttons[i].classList.remove("active");
            }
            document.getElementById(tabName).classList.remove("hidden");
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");

            // Refresh data when switching to tracking or view data tabs
            if (tabName === 'trackSamples') {
                renderTrackSamplesTable();
            } else if (tabName === 'viewData') {
                renderViewDataTable();
            }
        }

        // Function to add a new sample request block
        function addSampleRequest() {
            sampleCounter++;
            const container = document.getElementById('sampleRequestsContainer');
            const newBlock = document.createElement('div');
            newBlock.id = `sampleBlock-${sampleCounter}`;
            newBlock.classList.add('sample-request-block');
            newBlock.innerHTML = `
                <button type="button" class="remove-button" onclick="removeSampleRequest('sampleBlock-${sampleCounter}')">Remove</button>
                <h3 class="text-xl font-semibold mb-4 mit-blue">Sample #${sampleCounter} Details</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="form-group">
                        <label for="sampleID-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Sample ID (Unique):</label>
                        <input type="text" id="sampleID-${sampleCounter}" name="sampleID" placeholder="e.g., LOT-2025-001-S001" required>
                    </div>
                    <div class="form-group">
                        <label for="materialType-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Material Type:</label>
                        <input type="text" id="materialType-${sampleCounter}" name="materialType" placeholder="e.g., Uranium Dioxide, Zirconium Alloy" required>
                    </div>
                    <div class="form-group">
                        <label for="materialForm-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Material Form:</label>
                        <select id="materialForm-${sampleCounter}" name="materialForm" required>
                            <option value="">Select Form</option>
                            <option value="Pellet">Pellet</option>
                            <option value="Rod">Rod</option>
                            <option value="Plate">Plate</option>
                            <option value="Powder">Powder</option>
                            <option value="Liquid">Liquid</option>
                            <option value="Gas">Gas</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group col-span-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Sample Dimensions (mm):</label>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                            <input type="number" id="length-${sampleCounter}" name="length" placeholder="Length" step="any">
                            <input type="number" id="width-${sampleCounter}" name="width" placeholder="Width" step="any">
                            <input type="number" id="thickness-${sampleCounter}" name="thickness" placeholder="Thickness" step="any">
                            <input type="number" id="diameter-${sampleCounter}" name="diameter" placeholder="Diameter" step="any">
                        </div>
                        <p class="text-xs text-gray-500 mt-1">Leave blank if not applicable. Provide at least one relevant dimension.</p>
                    </div>
                    <div class="form-group">
                        <label for="sampleMass-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Sample Mass (g):</label>
                        <input type="number" id="sampleMass-${sampleCounter}" name="sampleMass" placeholder="e.g., 10.5" step="any" required>
                    </div>
                    <div class="form-group">
                        <label for="purity-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Purity (%):</label>
                        <input type="number" id="purity-${sampleCounter}" name="purity" placeholder="e.g., 99.9" step="0.01" min="0" max="100">
                    </div>
                    <div class="form-group">
                        <label for="enrichment-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Enrichment (%):</label>
                        <input type="number" id="enrichment-${sampleCounter}" name="enrichment" placeholder="e.g., 5.0 (for U-235)" step="0.01" min="0" max="100">
                    </div>
                    <div class="form-group col-span-full">
                        <label class="block text-sm font-medium text-gray-700 mb-2">Composition (Element/Isotope and Percentage):</label>
                        <table class="composition-table" id="compositionTable-${sampleCounter}">
                            <thead>
                                <tr>
                                    <th>Element</th>
                                    <th>Isotope</th>
                                    <th>Percentage (%)</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                </tbody>
                        </table>
                        <button type="button" onclick="addCompositionRow(${sampleCounter})" class="mt-2 mit-light-blue-bg text-mit-blue py-1 px-3 rounded-md text-sm hover:opacity-90">Add Element</button>
                    </div>
                    <div class="form-group">
                        <label for="experimentType-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Experiment Type:</label>
                        <select id="experimentType-${sampleCounter}" name="experimentType" required>
                            <option value="">Select Type</option>
                            <option value="Irradiation">Irradiation</option>
                            <option value="Post-Irradiation Examination (PIE)">Post-Irradiation Examination (PIE)</option>
                            <option value="Material Characterization">Material Characterization</option>
                            <option value="Corrosion Study">Corrosion Study</option>
                            <option value="Thermal Properties">Thermal Properties</option>
                            <option value="Mechanical Testing">Mechanical Testing</option>
                            <option value="Other">Other</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="requestedIrradiationDose-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Requested Irradiation Dose (dpa or n/cm²):</label>
                        <input type="text" id="requestedIrradiationDose-${sampleCounter}" name="requestedIrradiationDose" placeholder="e.g., 10 dpa, 1e21 n/cm²">
                    </div>
                    <div class="form-group">
                        <label for="requestedIrradiationTemperature-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Requested Irradiation Temperature (°C):</label>
                        <input type="number" id="requestedIrradiationTemperature-${sampleCounter}" name="requestedIrradiationTemperature" placeholder="e.g., 300" step="any">
                    </div>
                    <div class="form-group col-span-full">
                        <label for="specialInstructions-${sampleCounter}" class="block text-sm font-medium text-gray-700 mb-2">Special Instructions for this Sample:</label>
                        <textarea id="specialInstructions-${sampleCounter}" name="specialInstructions" rows="3" placeholder="Any specific details for this individual sample..."></textarea>
                    </div>
                </div>
            `;
            container.appendChild(newBlock);
            addCompositionRow(sampleCounter); // Add an initial composition row
            populateElementsDropdown(sampleCounter); // Populate element dropdown for the new block
        }

        // Function to remove a sample request block
        function removeSampleRequest(blockId) {
            const blockToRemove = document.getElementById(blockId);
            if (blockToRemove) {
                blockToRemove.remove();
            }
        }

        // Function to populate elements dropdown
        function populateElementsDropdown(sampleBlockIndex) {
            const elementSelects = document.querySelectorAll(`#sampleBlock-${sampleBlockIndex} .element-select`);
            elementSelects.forEach(select => {
                if (select.options.length === 0 || select.options[0].value !== "") { // Prevent re-populating
                    select.innerHTML = '<option value="">Select Element</option>';
                    periodicElements.forEach(element => {
                        const option = document.createElement('option');
                        option.value = element.symbol;
                        option.textContent = `${element.name} (${element.symbol})`;
                        select.appendChild(option);
                    });
                }
            });
        }

        // Function to update isotopes dropdown based on selected element
        function updateIsotopes(selectElement) {
            const isotopeSelect = selectElement.closest('tr').querySelector('.isotope-select');
            const selectedSymbol = selectElement.value;
            isotopeSelect.innerHTML = '<option value="">Select Isotope</option>';

            if (selectedSymbol) {
                const element = periodicElements.find(el => el.symbol === selectedSymbol);
                if (element && element.isotopes) {
                    element.isotopes.forEach(isotope => {
                        const option = document.createElement('option');
                        option.value = isotope;
                        option.textContent = isotope;
                        isotopeSelect.appendChild(option);
                    });
                }
            }
        }

        // Function to add a new row to the composition table
        function addCompositionRow(sampleBlockIndex) {
            const tableBody = document.querySelector(`#compositionTable-${sampleBlockIndex} tbody`);
            const newRow = tableBody.insertRow();
            newRow.innerHTML = `
                <td>
                    <select class="element-select" onchange="updateIsotopes(this)">
                        <option value="">Select Element</option>
                    </select>
                </td>
                <td>
                    <select class="isotope-select">
                        <option value="">Select Isotope</option>
                    </select>
                </td>
                <td><input type="number" class="percentage-input" placeholder="e.g., 50.0" step="0.01" min="0" max="100"></td>
                <td><button type="button" onclick="removeCompositionRow(this)" class="text-red-500 hover:text-red-700 text-sm">Remove</button></td>
            `;
            populateElementsDropdown(sampleBlockIndex); // Populate for the newly added row
        }

        // Function to remove a row from the composition table
        function removeCompositionRow(button) {
            const row = button.closest('tr');
            row.remove();
        }

        // Handle form submission for sample requests
        document.getElementById('sampleRequestForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            showMessage("Submitting request...", 'info');

            const collaboratorName = document.getElementById('collaboratorName').value;
            const collaboratorCompany = document.getElementById('collaboratorCompany').value;
            const collaboratorEmail = document.getElementById('collaboratorEmail').value;
            const collaboratorPhone = document.getElementById('collaboratorPhone').value;
            const lotNumber = document.getElementById('lotNumber').value;
            const generalSpecialInstructions = document.getElementById('generalSpecialInstructions').value;

            const samples = [];
            const sampleBlocks = document.querySelectorAll('.sample-request-block');

            // Validate Lot Number uniqueness (client-side check for immediate feedback)
            // This is a basic check, server-side validation would be more robust.
            // For now, we'll assume the GS backend will handle potential duplicates gracefully or append.
            // If strict uniqueness is required, GS would need to check existing lot numbers.

            for (const block of sampleBlocks) {
                const sampleID = block.querySelector('[name="sampleID"]').value;
                const materialType = block.querySelector('[name="materialType"]').value;
                const materialForm = block.querySelector('[name="materialForm"]').value;
                const length = block.querySelector('[name="length"]').value;
                const width = block.querySelector('[name="width"]').value;
                const thickness = block.querySelector('[name="thickness"]').value;
                const diameter = block.querySelector('[name="diameter"]').value;
                const sampleMass = block.querySelector('[name="sampleMass"]').value;
                const purity = block.querySelector('[name="purity"]').value;
                const enrichment = block.querySelector('[name="enrichment"]').value;
                const experimentType = block.querySelector('[name="experimentType"]').value;
                const requestedIrradiationDose = block.querySelector('[name="requestedIrradiationDose"]').value;
                const requestedIrradiationTemperature = block.querySelector('[name="requestedIrradiationTemperature"]').value;
                const specialInstructions = block.querySelector('[name="specialInstructions"]').value;

                const composition = [];
                const compositionRows = block.querySelectorAll('.composition-table tbody tr');
                compositionRows.forEach(row => {
                    const element = row.querySelector('.element-select').value;
                    const isotope = row.querySelector('.isotope-select').value;
                    const percentage = row.querySelector('.percentage-input').value;
                    if (element && percentage) { // Only add if element and percentage are provided
                        composition.push({ element, isotope, percentage: parseFloat(percentage) });
                    }
                });

                samples.push({
                    sampleID,
                    materialType,
                    materialForm,
                    sampleDimensions: {
                        length: length ? parseFloat(length) : null,
                        width: width ? parseFloat(width) : null,
                        thickness: thickness ? parseFloat(thickness) : null,
                        diameter: diameter ? parseFloat(diameter) : null,
                    },
                    sampleMass: parseFloat(sampleMass),
                    purity: purity ? parseFloat(purity) : null,
                    enrichment: enrichment ? parseFloat(enrichment) : null,
                    composition,
                    experimentType,
                    requestedIrradiationDose,
                    requestedIrradiationTemperature: requestedIrradiationTemperature ? parseFloat(requestedIrradiationTemperature) : null,
                    specialInstructions
                });
            }

            const formData = {
                collaboratorName,
                collaboratorCompany,
                collaboratorEmail,
                collaboratorPhone,
                lotNumber,
                generalSpecialInstructions,
                samples
            };

            try {
                // Use google.script.run to call the GS function
                google.script.run
                    .withSuccessHandler(function(response) {
                        showMessage(response, 'success');
                        document.getElementById('sampleRequestForm').reset(); // Clear form
                        document.getElementById('sampleRequestsContainer').innerHTML = ''; // Clear dynamic blocks
                        addSampleRequest(); // Add one empty block back
                        renderTrackSamplesTable(); // Refresh tracking table
                        renderViewDataTable(); // Refresh view data table
                    })
                    .withFailureHandler(function(error) {
                        console.error("Error submitting request:", error.message);
                        showMessage("Error submitting request: " + error.message, 'error');
                    })
                    .submitRequest(formData); // Call the GS function
            } catch (error) {
                console.error("Client-side error during submission:", error);
                showMessage("An unexpected client-side error occurred.", 'error');
            }
        });

        // Function to render the Track Samples table
        async function renderTrackSamplesTable() {
            const tableBody = document.getElementById('sampleTrackingTableBody');
            tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">Loading tracking data...</td></tr>';

            try {
                const data = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getSampleTrackingData();
                });

                tableBody.innerHTML = ''; // Clear loading message

                if (data.length <= 1) { // Only headers or no data
                    tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-gray-500">No sample requests to track yet.</td></tr>';
                    return;
                }

                // Group samples by Lot Number
                const groupedByLot = {};
                // Skip header row (index 0)
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    const lotNumber = row[0]; // Lot Number
                    if (!groupedByLot[lotNumber]) {
                        groupedByLot[lotNumber] = [];
                    }
                    groupedByLot[lotNumber].push(row);
                }

                for (const lotNumber in groupedByLot) {
                    const samplesInLot = groupedByLot[lotNumber];

                    // Add a header row for the Lot Number
                    const lotHeaderRow = tableBody.insertRow();
                    lotHeaderRow.classList.add('lot-header');
                    const lotHeaderCell = lotHeaderRow.insertCell(0);
                    lotHeaderCell.colSpan = 7;
                    lotHeaderCell.textContent = `Lot Number: ${lotNumber}`;

                    samplesInLot.forEach(sample => {
                        const row = tableBody.insertRow();
                        row.classList.add('tracking-input-row-dynamic'); // Apply dynamic row styling

                        const sampleID = sample[1]; // Sample ID
                        const material = sample[2]; // Material
                        const experimentType = sample[3]; // Experiment Type
                        const status = sample[4]; // Status
                        const approvalDate = sample[5] ? new Date(sample[5]).toLocaleDateString() : 'N/A'; // Approval Date
                        const shippingInstructions = sample[6] || 'N/A'; // Shipping Instructions
                        const trackingNumber = sample[7] || ''; // Tracking Number

                        row.insertCell(0).textContent = sampleID;
                        row.insertCell(1).textContent = material;
                        row.insertCell(2).textContent = experimentType;
                        row.insertCell(3).textContent = status;
                        row.insertCell(4).textContent = approvalDate;
                        row.insertCell(5).textContent = shippingInstructions;

                        const trackingCell = row.insertCell(6);
                        if (status === 'Approved' && !trackingNumber) { // Only show input if approved and no tracking yet
                            trackingCell.innerHTML = `
                                <div class="flex items-center space-x-2">
                                    <input type="text" id="trackingInput-${sampleID}" placeholder="Enter Tracking #" class="p-2 border rounded-md text-sm w-full">
                                    <button type="button" onclick="addTrackingDetails('${lotNumber}', '${sampleID}')"
                                            class="mit-blue-bg hover:opacity-90 text-white py-2 px-3 rounded-md text-sm">
                                        Add
                                    </button>
                                </div>
                            `;
                        } else {
                            trackingCell.textContent = trackingNumber || 'Pending';
                        }
                    });
                }
            } catch (error) {
                console.error("Error fetching tracking data:", error.message);
                showMessage("Error loading tracking data: " + error.message, 'error');
                tableBody.innerHTML = '<tr><td colspan="7" class="text-center py-4 text-red-500">Failed to load data. Please try again.</td></tr>';
            }
        }

        // Function to add tracking details (called from table)
        async function addTrackingDetails(lotNumber, sampleID) {
            const trackingInput = document.getElementById(`trackingInput-${sampleID}`);
            const trackingNumber = trackingInput.value.trim();
            if (!trackingNumber) {
                showMessage("Please enter a tracking number.", 'error');
                return;
            }

            showMessage("Adding tracking details...", 'info');

            // Get collaborator email from the form (assuming it's still available or fetched)
            const collaboratorEmail = document.getElementById('collaboratorEmail').value;
            const collaboratorName = document.getElementById('collaboratorName').value;

            const dataToSend = {
                lotNumber: lotNumber,
                sampleID: sampleID,
                trackingNumber: trackingNumber,
                collaboratorEmail: collaboratorEmail,
                collaboratorName: collaboratorName
            };

            try {
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .addTrackingDetails(dataToSend);
                });
                showMessage("Tracking details added successfully!", 'success');
                renderTrackSamplesTable(); // Refresh table to show updated status
            } catch (error) {
                console.error("Error adding tracking details:", error.message);
                showMessage("Error adding tracking details: " + error.message, 'error');
            }
        }

        // Function to refresh track samples table
        function refreshTrackSamples() {
            renderTrackSamplesTable();
            showMessage("Tracking data refreshed.", 'info');
        }

        // Function to render the View Sample Data table
        async function renderViewDataTable() {
            const tableBody = document.getElementById('sampleDataTableBody');
            tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">Loading sample data...</td></tr>';

            try {
                const data = await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .getSampleData();
                });

                tableBody.innerHTML = ''; // Clear loading message

                if (data.length <= 1) { // Only headers or no data
                    tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-gray-500">No sample data available yet.</td></tr>';
                    return;
                }

                // Group samples by Lot Number
                const groupedByLot = {};
                // Skip header row (index 0)
                for (let i = 1; i < data.length; i++) {
                    const row = data[i];
                    const lotNumber = row[0]; // Lot Number
                    if (!groupedByLot[lotNumber]) {
                        groupedByLot[lotNumber] = [];
                    }
                    groupedByLot[lotNumber].push(row);
                }

                for (const lotNumber in groupedByLot) {
                    const samplesInLot = groupedByLot[lotNumber];

                    // Add a header row for the Lot Number
                    const lotHeaderRow = tableBody.insertRow();
                    lotHeaderRow.classList.add('lot-header');
                    const lotHeaderCell = lotHeaderRow.insertCell(0);
                    lotHeaderCell.colSpan = 5;
                    lotHeaderCell.textContent = `Lot Number: ${lotNumber}`;

                    samplesInLot.forEach(sample => {
                        const row = tableBody.insertRow();
                        row.classList.add('lot-data-request-row-dynamic'); // Apply dynamic row styling

                        const sampleID = sample[1]; // Sample ID
                        const experimentType = sample[2]; // Experiment Type
                        const lastUpdatedDate = sample[3] ? new Date(sample[3]).toLocaleDateString() : 'N/A'; // Last Updated Date
                        const dataAvailableLink = sample[4] || 'N/A'; // Data Available Link

                        row.insertCell(0).textContent = sampleID;
                        row.insertCell(1).textContent = experimentType;
                        row.insertCell(2).textContent = lastUpdatedDate;

                        const requestDataCell = row.insertCell(3);
                        requestDataCell.innerHTML = `
                            <button type="button" onclick="requestSampleData('${lotNumber}', '${sampleID}')"
                                    class="mit-blue-bg hover:opacity-90 text-white py-2 px-3 rounded-md text-sm">
                                Request
                            </button>
                        `;

                        const dataLinkCell = row.insertCell(4);
                        if (dataAvailableLink !== 'N/A') {
                            dataLinkCell.innerHTML = `<a href="${dataAvailableLink}" target="_blank" class="text-blue-600 hover:underline">View Data</a>`;
                        } else {
                            dataLinkCell.textContent = 'N/A';
                        }
                    });

                    // Add a row for requesting data for the entire lot
                    const requestLotDataRow = tableBody.insertRow();
                    requestLotDataRow.classList.add('bg-gray-100');
                    const requestLotDataCell = requestLotDataRow.insertCell(0);
                    requestLotDataCell.colSpan = 3;
                    requestLotDataCell.textContent = `Request data for entire Lot ${lotNumber}:`;
                    const requestLotButtonCell = requestLotDataRow.insertCell(1);
                    requestLotButtonCell.colSpan = 2;
                    requestLotButtonCell.innerHTML = `
                        <button type="button" onclick="requestSampleData('${lotNumber}', null)"
                                class="mit-orange-bg hover:opacity-90 text-white py-2 px-4 rounded-md text-sm">
                            Request All Data for Lot
                        </button>
                    `;
                }
            } catch (error) {
                console.error("Error fetching sample data:", error.message);
                showMessage("Error loading sample data: " + error.message, 'error');
                tableBody.innerHTML = '<tr><td colspan="5" class="text-center py-4 text-red-500">Failed to load data. Please try again.</td></tr>';
            }
        }

        // Function to request sample data (for individual sample or entire lot)
        async function requestSampleData(lotNumber, sampleID = null) {
            showMessage("Requesting data...", 'info');

            const collaboratorEmail = document.getElementById('collaboratorEmail').value;
            const collaboratorName = document.getElementById('collaboratorName').value;

            const dataToSend = {
                lotNumber: lotNumber,
                sampleID: sampleID,
                collaboratorEmail: collaboratorEmail,
                collaboratorName: collaboratorName
            };

            try {
                await new Promise((resolve, reject) => {
                    google.script.run
                        .withSuccessHandler(resolve)
                        .withFailureHandler(reject)
                        .requestData(dataToSend);
                });
                showMessage("Data request sent successfully! You will receive an email if new updates are made.", 'success');
                renderViewDataTable(); // Refresh table to show updated status
            } catch (error) {
                console.error("Error requesting data:", error.message);
                showMessage("Error requesting data: " + error.message, 'error');
            }
        }

        // Initial calls on page load (after login)
        window.onload = function() {
            // The initial addSampleRequest, renderTrackSamplesTable, and renderViewDataTable
            // are now called within handleLogin's success handler.
            // This ensures the Google Sheet is initialized first.
        };

        // Ensure at least one sample request block is present initially
        // This is now handled in handleLogin after GS init.
    </script>
</body>
</html>
